<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JSON REST API Tutorial - JSON REST API</title>
  <meta name="description" content="A lightweight, plugin-based REST API framework for Node.js">
  <link rel="icon" type="image/svg+xml" href="/json-rest-api/favicon.svg">
  <link rel="apple-touch-icon" href="/json-rest-api/apple-touch-icon.svg">
  <link rel="stylesheet" href="/json-rest-api/assets/css/style.css">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>JSON REST API Tutorial | JSON REST API</title>
<meta name="generator" content="Jekyll v3.9.5" />
<meta property="og:title" content="JSON REST API Tutorial" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A lightweight, plugin-based REST API framework for Node.js" />
<meta property="og:description" content="A lightweight, plugin-based REST API framework for Node.js" />
<link rel="canonical" href="http://localhost:4000/json-rest-api/GUIDE.html" />
<meta property="og:url" content="http://localhost:4000/json-rest-api/GUIDE.html" />
<meta property="og:site_name" content="JSON REST API" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="JSON REST API Tutorial" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"A lightweight, plugin-based REST API framework for Node.js","headline":"JSON REST API Tutorial","url":"http://localhost:4000/json-rest-api/GUIDE.html"}</script>
<!-- End Jekyll SEO tag -->

  <style>
    .highlight {
      position: relative;
    }
    pre {
      position: relative;
    }
    .copy-button {
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 500;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      color: #333;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    .copy-button:hover {
      background: rgba(255, 255, 255, 1);
      border-color: rgba(0, 0, 0, 0.2);
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .copy-button:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    .copy-button.copied {
      background: #10b981;
      color: white;
      border-color: #10b981;
    }
  </style>
</head>
<body>
  <header>
    <div class="wrapper">
      <h1><a href="/json-rest-api/">JSON REST API</a></h1>
      <nav>
        <a href="/json-rest-api/QUICKSTART">Quick Start</a>
        <a href="/json-rest-api/GUIDE">Guide</a>
        <a href="/json-rest-api/API">API Reference</a>
        <a href="/json-rest-api/ONBOARDING">Contribute</a>
        <a href="/json-rest-api/COMPARISON">Why json-rest-api</a>
      </nav>
    </div>
  </header>

  <main>
    <div class="page-content">
      <h1 id="json-rest-api-tutorial">JSON REST API Tutorial</h1>

<p>This tutorial will guide you through building a REST API using <code class="language-plaintext highlighter-rouge">jsonrestapi</code>. We’ll start with the basics and gradually add more features.</p>

<h2 id="quick-start">Quick Start</h2>

<p>Here’s a complete working example to get you started:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Api</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">hooked-api</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">RestApiPlugin</span><span class="p">,</span> <span class="nx">HttpPlugin</span><span class="p">,</span> <span class="nx">FileHandlingPlugin</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">json-rest-api</span><span class="dl">'</span><span class="p">;</span>

<span class="c1">// Create API</span>
<span class="kd">const</span> <span class="nx">api</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Api</span><span class="p">({</span> <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">my-api</span><span class="dl">'</span> <span class="p">});</span>

<span class="c1">// Create a reusable in-memory storage plugin</span>
<span class="c1">// (In production, you'd use RestApiKnexPlugin or another database plugin)</span>
<span class="kd">const</span> <span class="nx">inMemoryStoragePlugin</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">in-memory-storage</span><span class="dl">'</span><span class="p">,</span>
  <span class="nx">install</span><span class="p">({</span> <span class="nx">helpers</span> <span class="p">})</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">storage</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Map</span><span class="p">();</span>
    
    <span class="c1">// Seed with some initial data</span>
    <span class="nx">storage</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">books</span><span class="dl">'</span><span class="p">,</span> <span class="p">[</span>
      <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1</span><span class="dl">'</span><span class="p">,</span> <span class="na">title</span><span class="p">:</span> <span class="dl">'</span><span class="s1">The Great Gatsby</span><span class="dl">'</span><span class="p">,</span> <span class="na">author</span><span class="p">:</span> <span class="dl">'</span><span class="s1">F. Scott Fitzgerald</span><span class="dl">'</span><span class="p">,</span> <span class="na">year</span><span class="p">:</span> <span class="mi">1925</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">2</span><span class="dl">'</span><span class="p">,</span> <span class="na">title</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1984</span><span class="dl">'</span><span class="p">,</span> <span class="na">author</span><span class="p">:</span> <span class="dl">'</span><span class="s1">George Orwell</span><span class="dl">'</span><span class="p">,</span> <span class="na">year</span><span class="p">:</span> <span class="mi">1949</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">3</span><span class="dl">'</span><span class="p">,</span> <span class="na">title</span><span class="p">:</span> <span class="dl">'</span><span class="s1">To Kill a Mockingbird</span><span class="dl">'</span><span class="p">,</span> <span class="na">author</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Harper Lee</span><span class="dl">'</span><span class="p">,</span> <span class="na">year</span><span class="p">:</span> <span class="mi">1960</span> <span class="p">}</span>
    <span class="p">]);</span>

    <span class="nx">helpers</span><span class="p">.</span><span class="nx">dataQuery</span> <span class="o">=</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">scopeName</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">records</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">scopeName</span><span class="p">)</span> <span class="o">||</span> <span class="p">[];</span>
      <span class="k">return</span> <span class="p">{</span> 
        <span class="na">data</span><span class="p">:</span> <span class="nx">records</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">record</span> <span class="o">=&gt;</span> <span class="p">({</span>
          <span class="na">type</span><span class="p">:</span> <span class="nx">scopeName</span><span class="p">,</span>
          <span class="na">id</span><span class="p">:</span> <span class="nx">record</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
          <span class="na">attributes</span><span class="p">:</span> <span class="nx">record</span>
        <span class="p">}))</span>
      <span class="p">};</span>
    <span class="p">};</span>

    <span class="nx">helpers</span><span class="p">.</span><span class="nx">dataGet</span> <span class="o">=</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">scopeName</span><span class="p">,</span> <span class="nx">id</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">records</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">scopeName</span><span class="p">)</span> <span class="o">||</span> <span class="p">[];</span>
      <span class="kd">const</span> <span class="nx">record</span> <span class="o">=</span> <span class="nx">records</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">r</span> <span class="o">=&gt;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">id</span><span class="p">);</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">record</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span> <span class="na">data</span><span class="p">:</span> <span class="kc">null</span> <span class="p">};</span>
      <span class="p">}</span>
      
      <span class="k">return</span> <span class="p">{</span>
        <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">type</span><span class="p">:</span> <span class="nx">scopeName</span><span class="p">,</span>
          <span class="na">id</span><span class="p">:</span> <span class="nx">record</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
          <span class="na">attributes</span><span class="p">:</span> <span class="nx">record</span>
        <span class="p">}</span>
      <span class="p">};</span>
    <span class="p">};</span>

    <span class="nx">helpers</span><span class="p">.</span><span class="nx">dataPost</span> <span class="o">=</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">scopeName</span><span class="p">,</span> <span class="nx">inputRecord</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">records</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">scopeName</span><span class="p">)</span> <span class="o">||</span> <span class="p">[];</span>
      <span class="kd">const</span> <span class="nx">newRecord</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">id</span><span class="p">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">().</span><span class="nx">toString</span><span class="p">(),</span>
        <span class="p">...</span><span class="nx">inputRecord</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">attributes</span>
      <span class="p">};</span>
      
      <span class="nx">records</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">newRecord</span><span class="p">);</span>
      <span class="nx">storage</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="nx">scopeName</span><span class="p">,</span> <span class="nx">records</span><span class="p">);</span>
      
      <span class="k">return</span> <span class="p">{</span>
        <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">type</span><span class="p">:</span> <span class="nx">scopeName</span><span class="p">,</span>
          <span class="na">id</span><span class="p">:</span> <span class="nx">newRecord</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
          <span class="na">attributes</span><span class="p">:</span> <span class="nx">newRecord</span>
        <span class="p">}</span>
      <span class="p">};</span>
    <span class="p">};</span>

    <span class="nx">helpers</span><span class="p">.</span><span class="nx">dataPut</span> <span class="o">=</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">scopeName</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">inputRecord</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">records</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">scopeName</span><span class="p">)</span> <span class="o">||</span> <span class="p">[];</span>
      <span class="kd">const</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">records</span><span class="p">.</span><span class="nx">findIndex</span><span class="p">(</span><span class="nx">r</span> <span class="o">=&gt;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">id</span><span class="p">);</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Record not found</span><span class="dl">'</span><span class="p">);</span>
      <span class="p">}</span>
      
      <span class="nx">records</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">id</span><span class="p">,</span>
        <span class="p">...</span><span class="nx">inputRecord</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">attributes</span>
      <span class="p">};</span>
      
      <span class="k">return</span> <span class="p">{</span>
        <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">type</span><span class="p">:</span> <span class="nx">scopeName</span><span class="p">,</span>
          <span class="na">id</span><span class="p">:</span> <span class="nx">id</span><span class="p">,</span>
          <span class="na">attributes</span><span class="p">:</span> <span class="nx">records</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span>
        <span class="p">}</span>
      <span class="p">};</span>
    <span class="p">};</span>

    <span class="nx">helpers</span><span class="p">.</span><span class="nx">dataPatch</span> <span class="o">=</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">scopeName</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">inputRecord</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">records</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">scopeName</span><span class="p">)</span> <span class="o">||</span> <span class="p">[];</span>
      <span class="kd">const</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">records</span><span class="p">.</span><span class="nx">findIndex</span><span class="p">(</span><span class="nx">r</span> <span class="o">=&gt;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">id</span><span class="p">);</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Record not found</span><span class="dl">'</span><span class="p">);</span>
      <span class="p">}</span>
      
      <span class="nx">records</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">...</span><span class="nx">records</span><span class="p">[</span><span class="nx">index</span><span class="p">],</span>
        <span class="p">...</span><span class="nx">inputRecord</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">attributes</span>
      <span class="p">};</span>
      
      <span class="k">return</span> <span class="p">{</span>
        <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">type</span><span class="p">:</span> <span class="nx">scopeName</span><span class="p">,</span>
          <span class="na">id</span><span class="p">:</span> <span class="nx">id</span><span class="p">,</span>
          <span class="na">attributes</span><span class="p">:</span> <span class="nx">records</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span>
        <span class="p">}</span>
      <span class="p">};</span>
    <span class="p">};</span>

    <span class="nx">helpers</span><span class="p">.</span><span class="nx">dataDelete</span> <span class="o">=</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">scopeName</span><span class="p">,</span> <span class="nx">id</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">records</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">scopeName</span><span class="p">)</span> <span class="o">||</span> <span class="p">[];</span>
      <span class="kd">const</span> <span class="nx">filtered</span> <span class="o">=</span> <span class="nx">records</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">r</span> <span class="o">=&gt;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">id</span> <span class="o">!==</span> <span class="nx">id</span><span class="p">);</span>
      <span class="nx">storage</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="nx">scopeName</span><span class="p">,</span> <span class="nx">filtered</span><span class="p">);</span>
      <span class="k">return</span> <span class="p">{</span> <span class="na">success</span><span class="p">:</span> <span class="kc">true</span> <span class="p">};</span>
    <span class="p">};</span>

    <span class="nx">helpers</span><span class="p">.</span><span class="nx">dataExists</span> <span class="o">=</span> <span class="k">async</span> <span class="p">({</span> <span class="nx">scopeName</span><span class="p">,</span> <span class="nx">id</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">records</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">scopeName</span><span class="p">)</span> <span class="o">||</span> <span class="p">[];</span>
      <span class="k">return</span> <span class="nx">records</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">r</span> <span class="o">=&gt;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">id</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// Install plugins (order matters!)</span>
<span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">RestApiPlugin</span><span class="p">);</span>
<span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">inMemoryStoragePlugin</span><span class="p">);</span>
<span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">HttpPlugin</span><span class="p">);</span>

<span class="c1">// Define a resource</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">addResource</span><span class="p">(</span><span class="dl">'</span><span class="s1">books</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">schema</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">title</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
    <span class="na">author</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
    <span class="na">year</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">number</span><span class="dl">'</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// Start the server</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">startServer</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">API running at http://localhost:3000/api</span><span class="dl">'</span><span class="p">);</span>

<span class="c1">// Your API is now ready!</span>
<span class="c1">// GET http://localhost:3000/api/books</span>
<span class="c1">// POST http://localhost:3000/api/books</span>
<span class="c1">// etc.</span>
</code></pre></div></div>

<h2 id="table-of-contents">Table of Contents</h2>

<ol>
  <li><a href="#getting-started">Getting Started</a></li>
  <li><a href="#basic-rest-api-plugin">Basic REST API Plugin</a></li>
  <li><a href="#response-control-and-id-handling">Response Control and ID Handling</a>
    <ul>
      <li><a href="#return-full-record-configuration">Return Full Record Configuration</a></li>
      <li><a href="#strict-id-handling">Strict ID Handling</a></li>
    </ul>
  </li>
  <li><a href="#connector-plugins">Connector Plugins</a>
    <ul>
      <li><a href="#express-plugin">Express Plugin</a></li>
      <li><a href="#http-plugin">HTTP Plugin</a></li>
    </ul>
  </li>
  <li><a href="#file-storage">File Storage</a>
    <ul>
      <li><a href="#file-uploads-with-express">File Uploads with Express</a></li>
      <li><a href="#storage-adapters">Storage Adapters</a></li>
    </ul>
  </li>
</ol>

<h2 id="getting-started">Getting Started</h2>

<p>First, install the required packages:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm <span class="nb">install </span>hooked-api json-rest-api
<span class="c"># If you get peer dependency conflicts, use:</span>
<span class="c"># npm install hooked-api json-rest-api --legacy-peer-deps</span>
</code></pre></div></div>

<p>Create a new file called <code class="language-plaintext highlighter-rouge">api.js</code>:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Api</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">hooked-api</span><span class="dl">'</span><span class="p">;</span>

<span class="c1">// Create a new API instance</span>
<span class="kd">const</span> <span class="nx">api</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Api</span><span class="p">({</span>
  <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">my-library-api</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">version</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1.0.0</span><span class="dl">'</span>
<span class="p">});</span>
</code></pre></div></div>

<p>This is a pure Hooked API with no plugins. So, it doesn’t do anything.</p>

<h2 id="basic-rest-api-plugin">Basic REST API Plugin</h2>

<p>The <code class="language-plaintext highlighter-rouge">RestApiPlugin</code> is the foundation of jsonrestapi. It adds REST methods (query, get, post, put, patch, delete) to your API scopes.</p>

<h3 id="adding-the-rest-api-plugin">Adding the REST API Plugin</h3>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Api</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">hooked-api</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">RestApiPlugin</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">json-rest-api</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">api</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Api</span><span class="p">({</span>
  <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">my-library-api</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">version</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1.0.0</span><span class="dl">'</span>
<span class="p">});</span>

<span class="c1">// Use the REST API plugin</span>
<span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">RestApiPlugin</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="creating-a-books-resource">Creating a Books Resource</h3>

<p>Now let’s create a simple “books” resource with fake data:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Define a books resource</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">addResource</span><span class="p">(</span><span class="dl">'</span><span class="s1">books</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">schema</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">title</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
    <span class="na">author</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
    <span class="na">year</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">number</span><span class="dl">'</span> <span class="p">},</span>
    <span class="na">isbn</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// To actually use the REST API methods, you need a storage plugin</span>
<span class="c1">// Use the same inMemoryStoragePlugin from the Quick Start example above</span>
<span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">inMemoryStoragePlugin</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="using-the-api-programmatically">Using the API Programmatically</h3>

<p>With the REST API plugin and a storage plugin, you can now use the API programmatically:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Query all books</span>
<span class="kd">const</span> <span class="nx">allBooks</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">resources</span><span class="p">.</span><span class="nx">books</span><span class="p">.</span><span class="nx">query</span><span class="p">({});</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">allBooks</span><span class="p">);</span>
<span class="c1">// Output: { data: [{ type: 'books', id: '1', attributes: {...} }, ...] }</span>

<span class="c1">// Get a single book</span>
<span class="kd">const</span> <span class="nx">book</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">resources</span><span class="p">.</span><span class="nx">books</span><span class="p">.</span><span class="kd">get</span><span class="p">({</span> <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1</span><span class="dl">'</span> <span class="p">});</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">book</span><span class="p">);</span>
<span class="c1">// Output: { data: { type: 'books', id: '1', attributes: {...} } }</span>

<span class="c1">// Create a new book</span>
<span class="kd">const</span> <span class="nx">newBook</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">resources</span><span class="p">.</span><span class="nx">books</span><span class="p">.</span><span class="nx">post</span><span class="p">({</span>
  <span class="na">inputRecord</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">books</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">attributes</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">title</span><span class="p">:</span> <span class="dl">'</span><span class="s1">New Book</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">author</span><span class="p">:</span> <span class="dl">'</span><span class="s1">New Author</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">year</span><span class="p">:</span> <span class="mi">2024</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">newBook</span><span class="p">);</span>

<span class="c1">// Update a book (replace all fields)</span>
<span class="kd">const</span> <span class="nx">updatedBook</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">resources</span><span class="p">.</span><span class="nx">books</span><span class="p">.</span><span class="nx">put</span><span class="p">({</span>
  <span class="na">inputRecord</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">books</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">attributes</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">title</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Updated Title</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">author</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Updated Author</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">year</span><span class="p">:</span> <span class="mi">2024</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// Partially update a book</span>
<span class="kd">const</span> <span class="nx">patchedBook</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">resources</span><span class="p">.</span><span class="nx">books</span><span class="p">.</span><span class="nx">patch</span><span class="p">({</span>
  <span class="na">inputRecord</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">books</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">attributes</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">title</span><span class="p">:</span> <span class="dl">'</span><span class="s1">New Title Only</span><span class="dl">'</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// Delete a book</span>
<span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">resources</span><span class="p">.</span><span class="nx">books</span><span class="p">.</span><span class="k">delete</span><span class="p">({</span> <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1</span><span class="dl">'</span> <span class="p">});</span>
</code></pre></div></div>

<h2 id="response-control-and-id-handling">Response Control and ID Handling</h2>

<p>The REST API plugin provides advanced configuration options for controlling response payloads and ID validation behavior.</p>

<h3 id="return-full-record-configuration">Return Full Record Configuration</h3>

<p>By default, POST, PUT, and PATCH operations return the complete record including all fields, defaults, and relationships. You can configure this behavior to return minimal responses containing only the data that was sent in the request.</p>

<h4 id="configuration-levels">Configuration Levels</h4>

<p>The <code class="language-plaintext highlighter-rouge">returnFullRecord</code> option can be configured at three levels (from lowest to highest priority):</p>

<ol>
  <li><strong>API-level</strong> (default for all resources)</li>
  <li><strong>Resource-level</strong> (override for specific resources)</li>
  <li><strong>Method parameter</strong> (override for individual calls)</li>
</ol>

<h4 id="basic-configuration">Basic Configuration</h4>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// API-level configuration</span>
<span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">RestApiPlugin</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">returnFullRecord</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">post</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>   <span class="c1">// Don't return full record for POST</span>
    <span class="na">put</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>    <span class="c1">// Don't return full record for PUT</span>
    <span class="na">patch</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>  <span class="c1">// Don't return full record for PATCH</span>
    <span class="na">allowRemoteOverride</span><span class="p">:</span> <span class="kc">true</span>  <span class="c1">// Allow clients to override via query param</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// Resource-level override</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">addResource</span><span class="p">(</span><span class="dl">'</span><span class="s1">articles</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">schema</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">title</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
    <span class="na">body</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span> <span class="p">},</span>
    <span class="na">status</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">,</span> <span class="na">default</span><span class="p">:</span> <span class="dl">'</span><span class="s1">draft</span><span class="dl">'</span> <span class="p">}</span>
  <span class="p">},</span>
  <span class="na">returnFullRecord</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">post</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>  <span class="c1">// Always return full record for articles POST</span>
    <span class="na">allowRemoteOverride</span><span class="p">:</span> <span class="kc">false</span>  <span class="c1">// Don't allow client override for articles</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// Method-level override</span>
<span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">resources</span><span class="p">.</span><span class="nx">articles</span><span class="p">.</span><span class="nx">post</span><span class="p">({</span>
  <span class="na">inputRecord</span><span class="p">:</span> <span class="p">{</span> 
    <span class="na">data</span><span class="p">:</span> <span class="p">{</span> 
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">articles</span><span class="dl">'</span><span class="p">,</span> 
      <span class="na">attributes</span><span class="p">:</span> <span class="p">{</span> <span class="na">title</span><span class="p">:</span> <span class="dl">'</span><span class="s1">New Article</span><span class="dl">'</span> <span class="p">}</span> 
    <span class="p">}</span> 
  <span class="p">},</span>
  <span class="na">returnFullRecord</span><span class="p">:</span> <span class="kc">false</span>  <span class="c1">// Override for this specific call</span>
<span class="p">});</span>
</code></pre></div></div>

<h4 id="behavior-differences">Behavior Differences</h4>

<p><strong>Full Record (default, <code class="language-plaintext highlighter-rouge">returnFullRecord: true</code>):</strong></p>
<ul>
  <li>Returns the complete record after creation/update</li>
  <li>Includes all fields with their current database values</li>
  <li>Includes default values applied by schema or database</li>
  <li>Can include relationships if requested via <code class="language-plaintext highlighter-rouge">include</code> parameter</li>
  <li>Equivalent to performing a GET request after the operation</li>
</ul>

<p><strong>Minimal Record (<code class="language-plaintext highlighter-rouge">returnFullRecord: false</code>):</strong></p>
<ul>
  <li>Returns only the fields that were provided in the request</li>
  <li>Includes the generated/updated ID</li>
  <li>Does not include default values or unchanged fields</li>
  <li>More efficient for large records or when defaults aren’t needed</li>
  <li>Useful for bandwidth-constrained environments</li>
</ul>

<h4 id="example-responses">Example Responses</h4>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Input</span>
<span class="kd">const</span> <span class="nx">input</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">articles</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">attributes</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">title</span><span class="p">:</span> <span class="dl">'</span><span class="s1">My Article</span><span class="dl">'</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// With returnFullRecord: true (default)</span>
<span class="p">{</span>
  <span class="dl">"</span><span class="s2">data</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">articles</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">123</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">attributes</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">My Article</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">status</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">draft</span><span class="dl">"</span><span class="p">,</span>      <span class="c1">// Default value included</span>
      <span class="dl">"</span><span class="s2">createdAt</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">2024-01-01T00:00:00Z</span><span class="dl">"</span><span class="p">,</span>  <span class="c1">// Database-generated</span>
      <span class="dl">"</span><span class="s2">updatedAt</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">2024-01-01T00:00:00Z</span><span class="dl">"</span>   <span class="c1">// Database-generated</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// With returnFullRecord: false</span>
<span class="p">{</span>
  <span class="dl">"</span><span class="s2">data</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">articles</span><span class="dl">"</span><span class="p">,</span> 
    <span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">123</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">attributes</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">My Article</span><span class="dl">"</span>   <span class="c1">// Only what was provided</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="remote-override-via-query-parameters">Remote Override via Query Parameters</h4>

<p>When <code class="language-plaintext highlighter-rouge">allowRemoteOverride</code> is enabled, clients can control the response format using query parameters:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Request minimal response</span>
POST /api/articles?returnFullRecord<span class="o">=</span><span class="nb">false</span>

<span class="c"># Request full response (when API default is false)</span>
POST /api/articles?returnFullRecord<span class="o">=</span><span class="nb">true</span>
</code></pre></div></div>

<h3 id="strict-id-handling">Strict ID Handling</h3>

<p>By default, PUT and PATCH operations validate that the ID in the URL matches the ID in the request body (if provided). The <code class="language-plaintext highlighter-rouge">strictIdHandling</code> option allows you to relax this validation.</p>

<h4 id="configuration">Configuration</h4>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Programmatic usage - relaxed ID handling</span>
<span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">resources</span><span class="p">.</span><span class="nx">articles</span><span class="p">.</span><span class="nx">put</span><span class="p">({</span>
  <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">123</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">inputRecord</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">articles</span><span class="dl">'</span><span class="p">,</span>
      <span class="c1">// ID can be omitted or different when strictIdHandling: false</span>
      <span class="na">attributes</span><span class="p">:</span> <span class="p">{</span> 
        <span class="na">title</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Updated Title</span><span class="dl">'</span> 
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="na">strictIdHandling</span><span class="p">:</span> <span class="kc">false</span>  <span class="c1">// Default is true</span>
<span class="p">});</span>

<span class="c1">// With strict handling (default)</span>
<span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">resources</span><span class="p">.</span><span class="nx">articles</span><span class="p">.</span><span class="nx">put</span><span class="p">({</span>
  <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">123</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">inputRecord</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">articles</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">123</span><span class="dl">'</span><span class="p">,</span>  <span class="c1">// Must match URL parameter</span>
      <span class="na">attributes</span><span class="p">:</span> <span class="p">{</span> 
        <span class="na">title</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Updated Title</span><span class="dl">'</span> 
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<h4 id="behavior">Behavior</h4>

<p><strong>Strict ID Handling (<code class="language-plaintext highlighter-rouge">strictIdHandling: true</code>, default):</strong></p>
<ul>
  <li>ID in request body must match ID in URL (for PUT/PATCH)</li>
  <li>Throws validation error if IDs don’t match</li>
  <li>Follows standard JSON:API specification</li>
  <li>Recommended for public APIs</li>
</ul>

<p><strong>Relaxed ID Handling (<code class="language-plaintext highlighter-rouge">strictIdHandling: false</code>):</strong></p>
<ul>
  <li>ID in request body is optional</li>
  <li>If both URL and body have IDs, URL parameter takes precedence</li>
  <li>Body ID is ignored if it differs from URL</li>
  <li>Useful for internal APIs or migration scenarios</li>
</ul>

<h4 id="network-vs-programmatic-usage">Network vs Programmatic Usage</h4>

<p>The HTTP and Express connector plugins automatically set <code class="language-plaintext highlighter-rouge">strictIdHandling: true</code> for all network requests to ensure security and compliance with JSON:API specification. When using the API programmatically, it defaults to <code class="language-plaintext highlighter-rouge">false</code> for convenience.</p>

<h3 id="complete-example">Complete Example</h3>

<p>Here’s a complete example demonstrating both features:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Api</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">hooked-api</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">RestApiPlugin</span><span class="p">,</span> <span class="nx">ExpressPlugin</span><span class="p">,</span> <span class="nx">RestApiKnexPlugin</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">json-rest-api</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">express</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">api</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Api</span><span class="p">({</span> <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">my-api</span><span class="dl">'</span> <span class="p">});</span>

<span class="c1">// Configure REST API with custom settings</span>
<span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">RestApiPlugin</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">returnFullRecord</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">post</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="na">put</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="na">patch</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>  <span class="c1">// Only PATCH returns full record by default</span>
    <span class="na">allowRemoteOverride</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// Add Express connector</span>
<span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">ExpressPlugin</span><span class="p">,</span> <span class="p">{</span> <span class="na">basePath</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/api</span><span class="dl">'</span> <span class="p">});</span>

<span class="c1">// Add your database plugin</span>
<span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">RestApiKnexPlugin</span><span class="p">,</span> <span class="p">{</span> <span class="cm">/* your config */</span> <span class="p">});</span>

<span class="c1">// Define resources with overrides</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">addResource</span><span class="p">(</span><span class="dl">'</span><span class="s1">users</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">schema</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">name</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
    <span class="na">email</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
    <span class="na">role</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">,</span> <span class="na">default</span><span class="p">:</span> <span class="dl">'</span><span class="s1">user</span><span class="dl">'</span> <span class="p">},</span>
    <span class="na">createdAt</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">,</span> <span class="na">default</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">()</span> <span class="p">}</span>
  <span class="p">},</span>
  <span class="c1">// Users always return full record for audit purposes</span>
  <span class="na">returnFullRecord</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">post</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">put</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">patch</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">allowRemoteOverride</span><span class="p">:</span> <span class="kc">false</span>  <span class="c1">// Don't allow clients to change this</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">api</span><span class="p">.</span><span class="nx">addResource</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">schema</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">title</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
    <span class="na">content</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span> <span class="p">},</span>
    <span class="na">status</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">,</span> <span class="na">default</span><span class="p">:</span> <span class="dl">'</span><span class="s1">draft</span><span class="dl">'</span> <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">// Uses API defaults (minimal response)</span>
<span class="p">});</span>

<span class="c1">// Start server</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">api</span><span class="p">.</span><span class="nx">expressRouter</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>

<span class="c1">// Client examples:</span>

<span class="c1">// 1. Create post with minimal response (API default)</span>
<span class="c1">// POST /api/posts</span>
<span class="c1">// Returns: { "data": { "type": "posts", "id": "1", "attributes": { "title": "Hello" } } }</span>

<span class="c1">// 2. Create post with full response (query override)  </span>
<span class="c1">// POST /api/posts?returnFullRecord=true</span>
<span class="c1">// Returns: { "data": { "type": "posts", "id": "1", "attributes": { "title": "Hello", "status": "draft" } } }</span>

<span class="c1">// 3. Create user (always returns full record)</span>
<span class="c1">// POST /api/users?returnFullRecord=false  // Ignored due to allowRemoteOverride: false</span>
<span class="c1">// Returns: { "data": { "type": "users", "id": "2", "attributes": { "name": "John", "email": "john@example.com", "role": "user", "createdAt": "2024-01-01T00:00:00Z" } } }</span>

<span class="c1">// 4. Update with relaxed ID handling (programmatic)</span>
<span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">resources</span><span class="p">.</span><span class="nx">posts</span><span class="p">.</span><span class="nx">patch</span><span class="p">({</span>
  <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">inputRecord</span><span class="p">:</span> <span class="p">{</span> 
    <span class="na">data</span><span class="p">:</span> <span class="p">{</span> 
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">,</span>
      <span class="c1">// No ID required in body</span>
      <span class="na">attributes</span><span class="p">:</span> <span class="p">{</span> <span class="na">status</span><span class="p">:</span> <span class="dl">'</span><span class="s1">published</span><span class="dl">'</span> <span class="p">}</span> 
    <span class="p">}</span> 
  <span class="p">},</span>
  <span class="na">strictIdHandling</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="na">returnFullRecord</span><span class="p">:</span> <span class="kc">false</span>  <span class="c1">// Override to get minimal response</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="use-cases">Use Cases</h3>

<p><strong>When to use minimal responses (<code class="language-plaintext highlighter-rouge">returnFullRecord: false</code>):</strong></p>
<ul>
  <li>High-volume APIs where bandwidth is a concern</li>
  <li>When clients already have the full record and only need confirmation</li>
  <li>Mobile applications with limited data plans</li>
  <li>When default values are computed client-side</li>
</ul>

<p><strong>When to use relaxed ID handling (<code class="language-plaintext highlighter-rouge">strictIdHandling: false</code>):</strong></p>
<ul>
  <li>Internal microservice communication</li>
  <li>Data migration or synchronization scripts</li>
  <li>Legacy system integration</li>
  <li>Bulk update operations where IDs are in the URL path</li>
</ul>

<p>The connector plugins allow you to expose the API in several ways. The core plugins expose the API to Express or to pure Node.</p>

<h2 id="connector-plugins">Connector Plugins</h2>

<p>While the REST API plugin provides the core functionality, you need a connector plugin to expose your API over HTTP. You can choose between Express or the pure HTTP plugin.</p>

<blockquote>
  <p><strong>Important</strong>: Use either the Express plugin OR the HTTP plugin, not both!</p>
</blockquote>

<h3 id="features-common-to-both-plugins">Features (Common to Both Plugins)</h3>

<p>Both connector plugins provide these features:</p>

<ul>
  <li>Automatic route creation for all resources (GET, POST, PUT, PATCH, DELETE)</li>
  <li>Full JSON:API compliant request/response handling</li>
  <li>Query parameter parsing (include, fields, filter, sort, page)</li>
  <li>Request body parsing with configurable size limits</li>
  <li>Strict content type validation with <code class="language-plaintext highlighter-rouge">strictContentType</code> option (default: true)
    <ul>
      <li>Enforces <code class="language-plaintext highlighter-rouge">application/vnd.api+json</code> or <code class="language-plaintext highlighter-rouge">application/json</code> for POST/PUT/PATCH</li>
      <li>Returns 415 Unsupported Media Type for invalid content types</li>
    </ul>
  </li>
  <li>Error responses in JSON:API format with proper HTTP status codes (400, 403, 404, 405, 409, 415, 422, 500)</li>
  <li>File upload support when used with FileHandlingPlugin</li>
  <li>Access to raw request/response objects for advanced use cases</li>
  <li>Dynamic resource support (resources added after server startup work automatically)</li>
</ul>

<p>Example error response (same for both plugins):</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"errors"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
    </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"422"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Validation Error"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"detail"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Title is required"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"pointer"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/data/attributes/title"</span><span class="w"> </span><span class="p">}</span><span class="w">
  </span><span class="p">}]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="express-plugin">Express Plugin</h3>

<p>The Express plugin integrates your API with Express.js, the popular Node.js web framework. In addition to the common features above, it provides:</p>

<ul>
  <li>Middleware injection support (before/after routes, per-resource)</li>
  <li>Works with any Express middleware ecosystem</li>
  <li>Familiar Express router patterns</li>
</ul>

<p>First, install Express:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm <span class="nb">install </span>express
</code></pre></div></div>

<p>Then update your code:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Api</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">hooked-api</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">RestApiPlugin</span><span class="p">,</span> <span class="nx">ExpressPlugin</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">json-rest-api</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">express</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">api</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Api</span><span class="p">({</span>
  <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">my-library-api</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">version</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1.0.0</span><span class="dl">'</span>
<span class="p">});</span>

<span class="c1">// Add plugins</span>
<span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">RestApiPlugin</span><span class="p">);</span>
<span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">ExpressPlugin</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">basePath</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/api</span><span class="dl">'</span><span class="p">,</span>  <span class="c1">// Optional, defaults to '/api'</span>
<span class="p">});</span>

<span class="c1">// Add your books resource (you'll need a storage plugin for it to work)</span>
<span class="c1">// ...</span>

<span class="c1">// Create Express app</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="c1">// Mount the API routes - both approaches work:</span>

<span class="c1">// Approach 1: Direct router usage (standard Express pattern)</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">api</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">express</span><span class="p">.</span><span class="nx">router</span><span class="p">);</span>                    <span class="c1">// Mount at root</span>
<span class="c1">// OR</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="dl">'</span><span class="s1">/v1</span><span class="dl">'</span><span class="p">,</span> <span class="nx">api</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">express</span><span class="p">.</span><span class="nx">router</span><span class="p">);</span>             <span class="c1">// Mount at specific path</span>

<span class="c1">// Approach 2: Convenience method (adds logging)</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">express</span><span class="p">.</span><span class="nx">mount</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>                         <span class="c1">// Mount at root</span>
<span class="c1">// OR</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">express</span><span class="p">.</span><span class="nx">mount</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="dl">'</span><span class="s1">/v1</span><span class="dl">'</span><span class="p">);</span>                  <span class="c1">// Mount at specific path</span>

<span class="c1">// Note: The mount() method is just syntactic sugar that calls app.use() and logs the mount path</span>

<span class="c1">// Start the server</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">API running at http://localhost:3000/api</span><span class="dl">'</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Now your API is ready to receive HTTP requests!</p>

<h3 id="http-plugin">HTTP Plugin</h3>

<p>If you prefer not to use Express, the HTTP plugin provides a lightweight alternative using only Node.js built-in modules. In addition to the common features above, it provides:</p>

<ul>
  <li>Zero framework dependencies (pure Node.js)</li>
  <li>Built-in HTTP server with configurable port</li>
  <li>Multiple deployment options (standalone server, HTTPS with custom handler, integration with existing servers)</li>
  <li>Character encoding support (respects Content-Type charset)</li>
</ul>

<h4 id="configuration-options">Configuration Options</h4>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Api</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">hooked-api</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">RestApiPlugin</span><span class="p">,</span> <span class="nx">HttpPlugin</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">json-rest-api</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">api</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Api</span><span class="p">({</span>
  <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">my-library-api</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">version</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1.0.0</span><span class="dl">'</span>
<span class="p">});</span>

<span class="c1">// Add plugins</span>
<span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">RestApiPlugin</span><span class="p">);</span>
<span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">HttpPlugin</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">port</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span>                <span class="c1">// Server port (default: 3000)</span>
  <span class="na">basePath</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/api</span><span class="dl">'</span><span class="p">,</span>          <span class="c1">// API base path (default: '/api')</span>
  <span class="na">strictContentType</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>   <span class="c1">// Enforce JSON content types (default: true)</span>
  <span class="na">requestSizeLimit</span><span class="p">:</span> <span class="dl">'</span><span class="s1">10mb</span><span class="dl">'</span>   <span class="c1">// Max request body size (default: '1mb')</span>
<span class="p">});</span>

<span class="c1">// Add your books resource (you'll need a storage plugin for it to work)</span>
<span class="c1">// ...</span>

<span class="c1">// Start the HTTP server - multiple options:</span>

<span class="c1">// Option 1: Start on configured port (3000 by default)</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">startServer</span><span class="p">();</span>

<span class="c1">// Option 2: Start on a different port</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">startServer</span><span class="p">(</span><span class="mi">4000</span><span class="p">);</span>

<span class="c1">// Option 3: Access the raw server for custom configuration</span>
<span class="kd">const</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">api</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">server</span><span class="p">;</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">timeout</span> <span class="o">=</span> <span class="mi">60000</span><span class="p">;</span> <span class="c1">// 60 second timeout</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>

<span class="c1">// Option 4: Use with HTTPS</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">createServer</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">https</span><span class="dl">'</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">httpsServer</span> <span class="o">=</span> <span class="nx">createServer</span><span class="p">(</span><span class="nx">sslOptions</span><span class="p">,</span> <span class="nx">api</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">handler</span><span class="p">);</span>
<span class="nx">httpsServer</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">443</span><span class="p">);</span>

<span class="c1">// Option 5: Integrate into existing server</span>
<span class="nx">myExistingServer</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">request</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="dl">'</span><span class="s1">/api</span><span class="dl">'</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">handler</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// Handle other routes</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">API running at http://localhost:3000/api</span><span class="dl">'</span><span class="p">);</span>
</code></pre></div></div>

<h4 id="character-encoding">Character Encoding</h4>

<p>The plugin respects the charset parameter in Content-Type headers:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-X</span> POST http://localhost:3000/api/books <span class="se">\</span>
  <span class="nt">-H</span> <span class="s2">"Content-Type: application/json; charset=utf-16"</span> <span class="se">\</span>
  <span class="nt">-d</span> <span class="s1">'...'</span>
</code></pre></div></div>

<p>The HTTP plugin provides the same REST endpoints as Express but with zero external framework dependencies.</p>

<h3 id="using-your-rest-api">Using Your REST API</h3>

<p>Once you’ve set up either the Express or HTTP plugin, you can interact with your API using any HTTP client. Here are examples using curl that show the <strong>full JSON:API compliant responses</strong> you’ll receive:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Get all books</span>
curl http://localhost:3000/api/books

<span class="c"># Returns:</span>
<span class="o">{</span>
  <span class="s2">"data"</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">"type"</span>: <span class="s2">"books"</span>,
      <span class="s2">"id"</span>: <span class="s2">"1"</span>,
      <span class="s2">"attributes"</span>: <span class="o">{</span>
        <span class="s2">"title"</span>: <span class="s2">"The Great Gatsby"</span>,
        <span class="s2">"author"</span>: <span class="s2">"F. Scott Fitzgerald"</span>,
        <span class="s2">"year"</span>: 1925
      <span class="o">}</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"type"</span>: <span class="s2">"books"</span>,
      <span class="s2">"id"</span>: <span class="s2">"2"</span>,
      <span class="s2">"attributes"</span>: <span class="o">{</span>
        <span class="s2">"title"</span>: <span class="s2">"1984"</span>,
        <span class="s2">"author"</span>: <span class="s2">"George Orwell"</span>,
        <span class="s2">"year"</span>: 1949
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">]</span>
<span class="o">}</span>

<span class="c"># Get a single book</span>
curl http://localhost:3000/api/books/1

<span class="c"># Returns:</span>
<span class="o">{</span>
  <span class="s2">"data"</span>: <span class="o">{</span>
    <span class="s2">"type"</span>: <span class="s2">"books"</span>,
    <span class="s2">"id"</span>: <span class="s2">"1"</span>,
    <span class="s2">"attributes"</span>: <span class="o">{</span>
      <span class="s2">"title"</span>: <span class="s2">"The Great Gatsby"</span>,
      <span class="s2">"author"</span>: <span class="s2">"F. Scott Fitzgerald"</span>,
      <span class="s2">"year"</span>: 1925
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c"># Create a new book</span>
curl <span class="nt">-X</span> POST http://localhost:3000/api/books <span class="se">\</span>
  <span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span> <span class="se">\</span>
  <span class="nt">-d</span> <span class="s1">'{
    "data": {
      "type": "books",
      "attributes": {
        "title": "New Book",
        "author": "New Author",
        "year": 2024
      }
    }
  }'</span>

<span class="c"># Returns (201 Created):</span>
<span class="o">{</span>
  <span class="s2">"data"</span>: <span class="o">{</span>
    <span class="s2">"type"</span>: <span class="s2">"books"</span>,
    <span class="s2">"id"</span>: <span class="s2">"1234567890"</span>,
    <span class="s2">"attributes"</span>: <span class="o">{</span>
      <span class="s2">"title"</span>: <span class="s2">"New Book"</span>,
      <span class="s2">"author"</span>: <span class="s2">"New Author"</span>,
      <span class="s2">"year"</span>: 2024
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c"># Update a book</span>
curl <span class="nt">-X</span> PATCH http://localhost:3000/api/books/1 <span class="se">\</span>
  <span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span> <span class="se">\</span>
  <span class="nt">-d</span> <span class="s1">'{
    "data": {
      "type": "books",
      "id": "1",
      "attributes": {
        "title": "Updated Title"
      }
    }
  }'</span>

<span class="c"># Returns:</span>
<span class="o">{</span>
  <span class="s2">"data"</span>: <span class="o">{</span>
    <span class="s2">"type"</span>: <span class="s2">"books"</span>,
    <span class="s2">"id"</span>: <span class="s2">"1"</span>,
    <span class="s2">"attributes"</span>: <span class="o">{</span>
      <span class="s2">"title"</span>: <span class="s2">"Updated Title"</span>,
      <span class="s2">"author"</span>: <span class="s2">"F. Scott Fitzgerald"</span>,
      <span class="s2">"year"</span>: 1925
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c"># Delete a book</span>
curl <span class="nt">-X</span> DELETE http://localhost:3000/api/books/1

<span class="c"># Returns: 204 No Content (empty response)</span>
</code></pre></div></div>

<h3 id="file-upload-support-in-connector-plugins">File Upload Support in Connector Plugins</h3>

<p>Both the Express and HTTP plugins provide support for the FileHandlingPlugin by:</p>

<ol>
  <li>
    <p><strong>Providing raw request/response access</strong>: The plugins add <code class="language-plaintext highlighter-rouge">_httpReq</code> and <code class="language-plaintext highlighter-rouge">_httpRes</code> parameters that the FileHandlingPlugin uses to detect and parse multipart uploads.</p>
  </li>
  <li>
    <p><strong>Registering file detectors</strong>: When file uploads are enabled, the connector plugins register appropriate file detectors with the REST API.</p>
  </li>
</ol>

<h4 id="configuration-1">Configuration</h4>

<h5 id="express-plugin-1">Express Plugin</h5>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Api</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">hooked-api</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">RestApiPlugin</span><span class="p">,</span> <span class="nx">ExpressPlugin</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">json-rest-api</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">api</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Api</span><span class="p">({</span> <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">my-api</span><span class="dl">'</span> <span class="p">});</span>
<span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">RestApiPlugin</span><span class="p">);</span>

<span class="c1">// Configure Express plugin with file upload options</span>
<span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">ExpressPlugin</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">enableFileUploads</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>   <span class="c1">// Enable file upload support (default: true)</span>
  <span class="na">fileParser</span><span class="p">:</span> <span class="dl">'</span><span class="s1">busboy</span><span class="dl">'</span><span class="p">,</span>      <span class="c1">// Parser: 'busboy' or 'formidable'</span>
  <span class="na">fileParserOptions</span><span class="p">:</span> <span class="p">{</span>       <span class="c1">// Options passed to the file parser</span>
    <span class="na">limits</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">fileSize</span><span class="p">:</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="c1">// 10MB file size limit</span>
      <span class="na">files</span><span class="p">:</span> <span class="mi">5</span>                     <span class="c1">// Max 5 files per request</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<h5 id="http-plugin-1">HTTP Plugin</h5>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Api</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">hooked-api</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">RestApiPlugin</span><span class="p">,</span> <span class="nx">HttpPlugin</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">json-rest-api</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">api</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Api</span><span class="p">({</span> <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">my-api</span><span class="dl">'</span> <span class="p">});</span>
<span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">RestApiPlugin</span><span class="p">);</span>

<span class="c1">// Configure HTTP plugin with file upload options</span>
<span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">HttpPlugin</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">enableFileUploads</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>   <span class="c1">// Enable file upload support (default: true)</span>
  <span class="na">fileParser</span><span class="p">:</span> <span class="dl">'</span><span class="s1">busboy</span><span class="dl">'</span><span class="p">,</span>      <span class="c1">// Parser: 'busboy' or 'formidable'</span>
  <span class="na">fileParserOptions</span><span class="p">:</span> <span class="p">{</span>       <span class="c1">// Options passed to the file parser</span>
    <span class="na">limits</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">fileSize</span><span class="p">:</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="c1">// 10MB file size limit</span>
      <span class="na">files</span><span class="p">:</span> <span class="mi">5</span>                     <span class="c1">// Max 5 files per request</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<h4 id="file-parsers">File Parsers</h4>

<p>Both plugins support the same file parsers:</p>

<ul>
  <li><strong>busboy</strong>: Streaming parser, memory efficient, good for large files</li>
  <li><strong>formidable</strong>: Saves to temp files, includes progress tracking</li>
</ul>

<p><strong>Installation</strong>: File parsers must be installed separately:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># For busboy (recommended)</span>
npm <span class="nb">install </span>busboy

<span class="c"># For formidable</span>
npm <span class="nb">install </span>formidable
</code></pre></div></div>

<p><strong>Note</strong>: File parsing requires the FileHandlingPlugin to be loaded. The connector plugins only provide the detection and parsing capabilities; the actual file handling logic is implemented by the FileHandlingPlugin.</p>

<h2 id="file-storage">File Storage</h2>

<p>The file handling system allows you to accept file uploads in your API. It consists of three parts:</p>

<ol>
  <li>The <code class="language-plaintext highlighter-rouge">FileHandlingPlugin</code> - orchestrates file processing</li>
  <li>File detectors - parse multipart uploads (built into connector plugins)</li>
  <li>Storage adapters - save files to disk or cloud storage</li>
</ol>

<h3 id="setting-up-file-uploads">Setting Up File Uploads</h3>

<p>First, let’s add file support to our books API. We’ll allow users to upload book covers:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Api</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">hooked-api</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">RestApiPlugin</span><span class="p">,</span> <span class="nx">FileHandlingPlugin</span><span class="p">,</span> <span class="nx">ExpressPlugin</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">json-rest-api</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">LocalStorage</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">jsonrestapi/plugins/storage/local-storage.js</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">express</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">api</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Api</span><span class="p">({</span>
  <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">my-library-api</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">version</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1.0.0</span><span class="dl">'</span>
<span class="p">});</span>

<span class="c1">// Create a storage adapter</span>
<span class="kd">const</span> <span class="nx">coverStorage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LocalStorage</span><span class="p">({</span>
  <span class="na">directory</span><span class="p">:</span> <span class="dl">'</span><span class="s1">./uploads/covers</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">baseUrl</span><span class="p">:</span> <span class="dl">'</span><span class="s1">http://localhost:3000/uploads/covers</span><span class="dl">'</span>
<span class="p">});</span>

<span class="c1">// Add plugins (ORDER MATTERS!)</span>
<span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">RestApiPlugin</span><span class="p">);</span>
<span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">FileHandlingPlugin</span><span class="p">);</span>  <span class="c1">// Must come after RestApiPlugin</span>
<span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">ExpressPlugin</span><span class="p">);</span>       <span class="c1">// Must come after FileHandlingPlugin</span>

<span class="c1">// Update the books schema to include a cover image</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">addResource</span><span class="p">(</span><span class="dl">'</span><span class="s1">books</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">schema</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">title</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
    <span class="na">author</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
    <span class="na">year</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">number</span><span class="dl">'</span> <span class="p">},</span>
    <span class="na">isbn</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span> <span class="p">},</span>
    <span class="na">cover</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">file</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">storage</span><span class="p">:</span> <span class="nx">coverStorage</span><span class="p">,</span>
      <span class="na">accepts</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">image/jpeg</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">image/png</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">image/gif</span><span class="dl">'</span><span class="p">],</span>
      <span class="na">maxSize</span><span class="p">:</span> <span class="dl">'</span><span class="s1">5mb</span><span class="dl">'</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// You'll need a storage plugin to handle the data</span>
<span class="c1">// Use the same inMemoryStoragePlugin from the Quick Start example</span>
<span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">inMemoryStoragePlugin</span><span class="p">);</span>

<span class="c1">// Create Express app</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="c1">// Serve uploaded files</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="dl">'</span><span class="s1">/uploads</span><span class="dl">'</span><span class="p">,</span> <span class="nx">express</span><span class="p">.</span><span class="kd">static</span><span class="p">(</span><span class="dl">'</span><span class="s1">./uploads</span><span class="dl">'</span><span class="p">));</span>

<span class="c1">// Mount the API (both approaches work)</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">api</span><span class="p">.</span><span class="nx">express</span><span class="p">.</span><span class="nx">router</span><span class="p">);</span>       <span class="c1">// Direct Express approach</span>
<span class="c1">// OR</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">express</span><span class="p">.</span><span class="nx">mount</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>            <span class="c1">// Convenience method</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">API with file uploads running at http://localhost:3000/api</span><span class="dl">'</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="file-uploads-with-express">File Uploads with Express</h3>

<p>To upload a file, you need to send a multipart/form-data request. Here’s an example HTML form:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;h2&gt;</span>Add a Book<span class="nt">&lt;/h2&gt;</span>
  <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"http://localhost:3000/api/books"</span> <span class="na">method=</span><span class="s">"POST"</span> <span class="na">enctype=</span><span class="s">"multipart/form-data"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;label&gt;</span>Title: <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"title"</span> <span class="na">required</span><span class="nt">&gt;&lt;/label&gt;&lt;br&gt;</span>
    <span class="nt">&lt;label&gt;</span>Author: <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"author"</span> <span class="na">required</span><span class="nt">&gt;&lt;/label&gt;&lt;br&gt;</span>
    <span class="nt">&lt;label&gt;</span>Year: <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"year"</span> <span class="na">type=</span><span class="s">"number"</span><span class="nt">&gt;&lt;/label&gt;&lt;br&gt;</span>
    <span class="nt">&lt;label&gt;</span>Cover: <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"cover"</span> <span class="na">type=</span><span class="s">"file"</span> <span class="na">accept=</span><span class="s">"image/*"</span><span class="nt">&gt;&lt;/label&gt;&lt;br&gt;</span>
    <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"submit"</span><span class="nt">&gt;</span>Add Book<span class="nt">&lt;/button&gt;</span>
  <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>Or using curl:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-X</span> POST http://localhost:3000/api/books <span class="se">\</span>
  <span class="nt">-F</span> <span class="s2">"title=The Hobbit"</span> <span class="se">\</span>
  <span class="nt">-F</span> <span class="s2">"author=J.R.R. Tolkien"</span> <span class="se">\</span>
  <span class="nt">-F</span> <span class="s2">"year=1937"</span> <span class="se">\</span>
  <span class="nt">-F</span> <span class="s2">"cover=@/path/to/cover.jpg"</span>
</code></pre></div></div>

<p>The file handling plugin will:</p>
<ol>
  <li>Detect the multipart upload</li>
  <li>Parse the files using busboy (you’ll need to install it: <code class="language-plaintext highlighter-rouge">npm install busboy</code>)</li>
  <li>Validate file type and size according to your schema</li>
  <li>Upload the file using the storage adapter</li>
  <li>Replace the file field with the uploaded file’s URL</li>
  <li>Convert everything to JSON:API format</li>
</ol>

<h3 id="storage-adapters">Storage Adapters</h3>

<h4 id="localstorage">LocalStorage</h4>

<p>The LocalStorage adapter saves files to your local filesystem:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">LocalStorage</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">jsonrestapi/plugins/storage/local-storage.js</span><span class="dl">'</span><span class="p">;</span>

<span class="c1">// Basic usage</span>
<span class="kd">const</span> <span class="nx">storage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LocalStorage</span><span class="p">({</span>
  <span class="na">directory</span><span class="p">:</span> <span class="dl">'</span><span class="s1">./uploads</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">baseUrl</span><span class="p">:</span> <span class="dl">'</span><span class="s1">http://localhost:3000/uploads</span><span class="dl">'</span>
<span class="p">});</span>

<span class="c1">// With security options</span>
<span class="kd">const</span> <span class="nx">secureStorage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LocalStorage</span><span class="p">({</span>
  <span class="na">directory</span><span class="p">:</span> <span class="dl">'</span><span class="s1">./uploads</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">baseUrl</span><span class="p">:</span> <span class="dl">'</span><span class="s1">http://localhost:3000/uploads</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">nameStrategy</span><span class="p">:</span> <span class="dl">'</span><span class="s1">hash</span><span class="dl">'</span><span class="p">,</span>  <span class="c1">// Generate random filenames</span>
  <span class="na">allowedExtensions</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">.jpg</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">.jpeg</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">.png</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">.pdf</span><span class="dl">'</span><span class="p">],</span>
  <span class="na">maxFilenameLength</span><span class="p">:</span> <span class="mi">255</span>
<span class="p">});</span>

<span class="c1">// Different naming strategies</span>
<span class="kd">const</span> <span class="nx">customStorage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LocalStorage</span><span class="p">({</span>
  <span class="na">directory</span><span class="p">:</span> <span class="dl">'</span><span class="s1">./uploads</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">baseUrl</span><span class="p">:</span> <span class="dl">'</span><span class="s1">http://localhost:3000/uploads</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">nameStrategy</span><span class="p">:</span> <span class="dl">'</span><span class="s1">custom</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">nameGenerator</span><span class="p">:</span> <span class="k">async</span> <span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// Generate your own filename</span>
    <span class="kd">const</span> <span class="nx">timestamp</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">random</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">().</span><span class="nx">toString</span><span class="p">(</span><span class="mi">36</span><span class="p">).</span><span class="nx">substring</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
    <span class="k">return</span> <span class="s2">`book_cover_</span><span class="p">${</span><span class="nx">timestamp</span><span class="p">}</span><span class="s2">_</span><span class="p">${</span><span class="nx">random</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<h4 id="s3storage-mock-implementation">S3Storage (Mock Implementation)</h4>

<p>The package includes a mock S3 storage adapter for development:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">S3Storage</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">jsonrestapi/plugins/storage/s3-storage.js</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">s3Storage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">S3Storage</span><span class="p">({</span>
  <span class="na">bucket</span><span class="p">:</span> <span class="dl">'</span><span class="s1">my-book-covers</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">region</span><span class="p">:</span> <span class="dl">'</span><span class="s1">us-east-1</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">prefix</span><span class="p">:</span> <span class="dl">'</span><span class="s1">covers/</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">mockMode</span><span class="p">:</span> <span class="kc">true</span>  <span class="c1">// Currently only mock mode is implemented</span>
<span class="p">});</span>
</code></pre></div></div>

<blockquote>
  <p><strong>Looking for a complete example with multiple files?</strong> Check out our <a href="docs/mini-guides/file-uploads-complete.md">Complete File Upload Guide</a> that shows multiple file fields, HTML forms, and static file serving.</p>
</blockquote>

<h2 id="transactions">Transactions</h2>

<p>The JSON REST API supports database transactions for atomic operations across multiple resources. This is essential for maintaining data consistency when creating or updating related resources.</p>

<h3 id="basic-transaction-usage">Basic Transaction Usage</h3>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Manual transaction management</span>
<span class="kd">const</span> <span class="nx">trx</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">knex</span><span class="p">.</span><span class="nx">instance</span><span class="p">.</span><span class="nx">transaction</span><span class="p">();</span>
<span class="k">try</span> <span class="p">{</span>
  <span class="c1">// All operations share the same transaction</span>
  <span class="kd">const</span> <span class="nx">author</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">resources</span><span class="p">.</span><span class="nx">people</span><span class="p">.</span><span class="nx">post</span><span class="p">({</span>
    <span class="na">transaction</span><span class="p">:</span> <span class="nx">trx</span><span class="p">,</span>
    <span class="na">inputRecord</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">people</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">attributes</span><span class="p">:</span> <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">New Author</span><span class="dl">'</span> <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span>
  
  <span class="kd">const</span> <span class="nx">book</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">resources</span><span class="p">.</span><span class="nx">books</span><span class="p">.</span><span class="nx">post</span><span class="p">({</span>
    <span class="na">transaction</span><span class="p">:</span> <span class="nx">trx</span><span class="p">,</span>
    <span class="na">inputRecord</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">books</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">attributes</span><span class="p">:</span> <span class="p">{</span> <span class="na">title</span><span class="p">:</span> <span class="dl">'</span><span class="s1">New Book</span><span class="dl">'</span> <span class="p">},</span>
        <span class="na">relationships</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">author</span><span class="p">:</span> <span class="p">{</span> <span class="na">data</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">people</span><span class="dl">'</span><span class="p">,</span> <span class="na">id</span><span class="p">:</span> <span class="nx">author</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">id</span> <span class="p">}</span> <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span>
  
  <span class="c1">// Commit if everything succeeds</span>
  <span class="k">await</span> <span class="nx">trx</span><span class="p">.</span><span class="nx">commit</span><span class="p">();</span>
  <span class="k">return</span> <span class="p">{</span> <span class="nx">author</span><span class="p">,</span> <span class="nx">book</span> <span class="p">};</span>
  
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Rollback on any error</span>
  <span class="k">await</span> <span class="nx">trx</span><span class="p">.</span><span class="nx">rollback</span><span class="p">();</span>
  <span class="k">throw</span> <span class="nx">error</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="automatic-transaction-handling">Automatic Transaction Handling</h3>

<p>POST operations automatically use transactions when creating resources with many-to-many relationships:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// This single POST will use a transaction internally</span>
<span class="kd">const</span> <span class="nx">book</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">resources</span><span class="p">.</span><span class="nx">books</span><span class="p">.</span><span class="nx">post</span><span class="p">({</span>
  <span class="na">inputRecord</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">books</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">attributes</span><span class="p">:</span> <span class="p">{</span> <span class="na">title</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Tagged Book</span><span class="dl">'</span> <span class="p">},</span>
      <span class="na">relationships</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">tags</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">data</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">tags</span><span class="dl">'</span><span class="p">,</span> <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1</span><span class="dl">'</span> <span class="p">},</span>
            <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">tags</span><span class="dl">'</span><span class="p">,</span> <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">2</span><span class="dl">'</span> <span class="p">}</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
<span class="c1">// The book and pivot table entries are created atomically</span>
</code></pre></div></div>

<h3 id="nested-transactions">Nested Transactions</h3>

<p>The system intelligently handles nested transactions by reusing existing ones:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">trx</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">knex</span><span class="p">.</span><span class="nx">instance</span><span class="p">.</span><span class="nx">transaction</span><span class="p">();</span>
<span class="k">try</span> <span class="p">{</span>
  <span class="c1">// This POST will use the existing transaction</span>
  <span class="kd">const</span> <span class="nx">book</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">resources</span><span class="p">.</span><span class="nx">books</span><span class="p">.</span><span class="nx">post</span><span class="p">({</span>
    <span class="na">transaction</span><span class="p">:</span> <span class="nx">trx</span><span class="p">,</span>
    <span class="na">inputRecord</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">books</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">attributes</span><span class="p">:</span> <span class="p">{</span> <span class="na">title</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Book with Tags</span><span class="dl">'</span> <span class="p">},</span>
        <span class="na">relationships</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">tags</span><span class="p">:</span> <span class="p">{</span> <span class="na">data</span><span class="p">:</span> <span class="p">[{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">tags</span><span class="dl">'</span><span class="p">,</span> <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1</span><span class="dl">'</span> <span class="p">}]</span> <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="c1">// Even though POST creates its own transaction for many-to-many,</span>
  <span class="c1">// it detects and uses the existing one</span>
  
  <span class="k">await</span> <span class="nx">trx</span><span class="p">.</span><span class="nx">commit</span><span class="p">();</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">await</span> <span class="nx">trx</span><span class="p">.</span><span class="nx">rollback</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="transaction-support-across-methods">Transaction Support Across Methods</h3>

<p>All REST API methods support transactions:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">trx</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">knex</span><span class="p">.</span><span class="nx">instance</span><span class="p">.</span><span class="nx">transaction</span><span class="p">();</span>
<span class="k">try</span> <span class="p">{</span>
  <span class="c1">// Query with transaction</span>
  <span class="kd">const</span> <span class="nx">books</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">resources</span><span class="p">.</span><span class="nx">books</span><span class="p">.</span><span class="nx">query</span><span class="p">({</span> 
    <span class="na">transaction</span><span class="p">:</span> <span class="nx">trx</span><span class="p">,</span>
    <span class="na">queryParams</span><span class="p">:</span> <span class="p">{</span> <span class="na">filters</span><span class="p">:</span> <span class="p">{</span> <span class="na">status</span><span class="p">:</span> <span class="dl">'</span><span class="s1">draft</span><span class="dl">'</span> <span class="p">}</span> <span class="p">}</span>
  <span class="p">});</span>
  
  <span class="c1">// Update with transaction</span>
  <span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">resources</span><span class="p">.</span><span class="nx">books</span><span class="p">.</span><span class="nx">patch</span><span class="p">({</span>
    <span class="na">transaction</span><span class="p">:</span> <span class="nx">trx</span><span class="p">,</span>
    <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">123</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">inputRecord</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">books</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">123</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">attributes</span><span class="p">:</span> <span class="p">{</span> <span class="na">status</span><span class="p">:</span> <span class="dl">'</span><span class="s1">published</span><span class="dl">'</span> <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span>
  
  <span class="c1">// Delete with transaction</span>
  <span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">resources</span><span class="p">.</span><span class="nx">drafts</span><span class="p">.</span><span class="k">delete</span><span class="p">({</span>
    <span class="na">transaction</span><span class="p">:</span> <span class="nx">trx</span><span class="p">,</span>
    <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">456</span><span class="dl">'</span>
  <span class="p">});</span>
  
  <span class="k">await</span> <span class="nx">trx</span><span class="p">.</span><span class="nx">commit</span><span class="p">();</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">await</span> <span class="nx">trx</span><span class="p">.</span><span class="nx">rollback</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="updating-resources-with-relationships">Updating Resources with Relationships</h2>

<p>The REST API plugin now fully supports updating relationships in PUT and PATCH operations according to JSON:API specifications.</p>

<h3 id="put---complete-replacement">PUT - Complete Replacement</h3>

<p>PUT replaces the entire resource, including all relationships. Any relationships not provided in the request will be removed.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Example: Update an article with new author and categories</span>
<span class="kd">const</span> <span class="nx">updatedArticle</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">resources</span><span class="p">.</span><span class="nx">articles</span><span class="p">.</span><span class="nx">put</span><span class="p">({</span>
  <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">123</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">inputRecord</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">articles</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">123</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">attributes</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">title</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Updated Title</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">body</span><span class="p">:</span> <span class="dl">'</span><span class="s1">New content</span><span class="dl">'</span>
      <span class="p">},</span>
      <span class="na">relationships</span><span class="p">:</span> <span class="p">{</span>
        <span class="c1">// 1:1 relationship - will update author_id in the database</span>
        <span class="na">author</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">data</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">users</span><span class="dl">'</span><span class="p">,</span> <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">42</span><span class="dl">'</span> <span class="p">}</span>
        <span class="p">},</span>
        <span class="c1">// n:n relationship - will replace ALL category associations</span>
        <span class="na">categories</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">data</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">categories</span><span class="dl">'</span><span class="p">,</span> <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1</span><span class="dl">'</span> <span class="p">},</span>
            <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">categories</span><span class="dl">'</span><span class="p">,</span> <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">3</span><span class="dl">'</span> <span class="p">}</span>
          <span class="p">]</span>
        <span class="p">}</span>
        <span class="c1">// Note: any other relationships not listed here will be cleared!</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="patch---partial-update">PATCH - Partial Update</h3>

<p>PATCH only updates the fields and relationships explicitly provided, leaving everything else unchanged.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Example: Update only the author, keeping categories unchanged</span>
<span class="kd">const</span> <span class="nx">patchedArticle</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">resources</span><span class="p">.</span><span class="nx">articles</span><span class="p">.</span><span class="nx">patch</span><span class="p">({</span>
  <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">123</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">inputRecord</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">articles</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">123</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">relationships</span><span class="p">:</span> <span class="p">{</span>
        <span class="c1">// Only update the author relationship</span>
        <span class="na">author</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">data</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">users</span><span class="dl">'</span><span class="p">,</span> <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">99</span><span class="dl">'</span> <span class="p">}</span>
        <span class="p">}</span>
        <span class="c1">// categories relationship remains untouched</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// Example: Clear a relationship by setting it to null</span>
<span class="kd">const</span> <span class="nx">clearedRelationship</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">resources</span><span class="p">.</span><span class="nx">articles</span><span class="p">.</span><span class="nx">patch</span><span class="p">({</span>
  <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">123</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">inputRecord</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">articles</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">123</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">relationships</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">reviewer</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">data</span><span class="p">:</span> <span class="kc">null</span>  <span class="c1">// Removes the reviewer</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// Example: Update many-to-many relationship</span>
<span class="kd">const</span> <span class="nx">updatedCategories</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">resources</span><span class="p">.</span><span class="nx">articles</span><span class="p">.</span><span class="nx">patch</span><span class="p">({</span>
  <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">123</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">inputRecord</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">articles</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">123</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">relationships</span><span class="p">:</span> <span class="p">{</span>
        <span class="c1">// This will replace the categories for this article</span>
        <span class="na">categories</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">data</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">categories</span><span class="dl">'</span><span class="p">,</span> <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">5</span><span class="dl">'</span> <span class="p">},</span>
            <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">categories</span><span class="dl">'</span><span class="p">,</span> <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">7</span><span class="dl">'</span> <span class="p">},</span>
            <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">categories</span><span class="dl">'</span><span class="p">,</span> <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">9</span><span class="dl">'</span> <span class="p">}</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="transaction-support-for-relationship-updates">Transaction Support for Relationship Updates</h3>

<p>All relationship updates are performed within the same transaction as the main record update, ensuring data consistency:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// This entire operation is atomic</span>
<span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">resources</span><span class="p">.</span><span class="nx">articles</span><span class="p">.</span><span class="nx">put</span><span class="p">({</span>
  <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">123</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">inputRecord</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">articles</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">123</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">attributes</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">title</span><span class="p">:</span> <span class="dl">'</span><span class="s1">New Title</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">status</span><span class="p">:</span> <span class="dl">'</span><span class="s1">published</span><span class="dl">'</span>
      <span class="p">},</span>
      <span class="na">relationships</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">author</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">data</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">users</span><span class="dl">'</span><span class="p">,</span> <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">10</span><span class="dl">'</span> <span class="p">}</span>
        <span class="p">},</span>
        <span class="na">categories</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">data</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">categories</span><span class="dl">'</span><span class="p">,</span> <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1</span><span class="dl">'</span> <span class="p">},</span>
            <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">categories</span><span class="dl">'</span><span class="p">,</span> <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">2</span><span class="dl">'</span> <span class="p">}</span>
          <span class="p">]</span>
        <span class="p">},</span>
        <span class="na">tags</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">data</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">tags</span><span class="dl">'</span><span class="p">,</span> <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">100</span><span class="dl">'</span> <span class="p">},</span>
            <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">tags</span><span class="dl">'</span><span class="p">,</span> <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">101</span><span class="dl">'</span> <span class="p">}</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
<span class="c1">// If any part fails, everything is rolled back</span>
</code></pre></div></div>

<h2 id="database-configuration-with-mysql">Database Configuration with MySQL</h2>

<p>The REST API Knex Plugin supports MySQL databases out of the box. Here’s how to configure your API to use MySQL:</p>

<h3 id="installing-mysql-driver">Installing MySQL Driver</h3>

<p>First, install the MySQL driver for Knex:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm <span class="nb">install </span>mysql2
</code></pre></div></div>

<h3 id="basic-mysql-configuration">Basic MySQL Configuration</h3>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Api</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">hooked-api</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">RestApiPlugin</span><span class="p">,</span> <span class="nx">RestApiKnexPlugin</span><span class="p">,</span> <span class="nx">HttpPlugin</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">json-rest-api</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">knex</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">knex</span><span class="dl">'</span><span class="p">;</span>

<span class="c1">// Create a Knex instance with MySQL configuration</span>
<span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">knex</span><span class="p">({</span>
  <span class="na">client</span><span class="p">:</span> <span class="dl">'</span><span class="s1">mysql2</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">connection</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">host</span><span class="p">:</span> <span class="dl">'</span><span class="s1">localhost</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">port</span><span class="p">:</span> <span class="mi">3306</span><span class="p">,</span>
    <span class="na">user</span><span class="p">:</span> <span class="dl">'</span><span class="s1">your_database_user</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">password</span><span class="p">:</span> <span class="dl">'</span><span class="s1">your_database_password</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">database</span><span class="p">:</span> <span class="dl">'</span><span class="s1">your_database_name</span><span class="dl">'</span>
  <span class="p">},</span>
  <span class="na">pool</span><span class="p">:</span> <span class="p">{</span> 
    <span class="na">min</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="na">max</span><span class="p">:</span> <span class="mi">10</span> 
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// Create the API</span>
<span class="kd">const</span> <span class="nx">api</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Api</span><span class="p">({</span> <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">my-api</span><span class="dl">'</span> <span class="p">});</span>

<span class="c1">// Install plugins</span>
<span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">RestApiPlugin</span><span class="p">);</span>
<span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">RestApiKnexPlugin</span><span class="p">,</span> <span class="p">{</span> <span class="na">knex</span><span class="p">:</span> <span class="nx">db</span> <span class="p">});</span>
<span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">HttpPlugin</span><span class="p">);</span>

<span class="c1">// The Knex instance is now available as api.knex for direct queries</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Database connected:</span><span class="dl">'</span><span class="p">,</span> <span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">knex</span><span class="p">.</span><span class="nx">raw</span><span class="p">(</span><span class="dl">'</span><span class="s1">SELECT 1+1 AS result</span><span class="dl">'</span><span class="p">));</span>

<span class="c1">// Add a sample resource</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">addResource</span><span class="p">(</span><span class="dl">'</span><span class="s1">users</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">schema</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">id</span><span class="dl">'</span> <span class="p">},</span>
    <span class="na">name</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
    <span class="na">email</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// Create the users table if it doesn't exist</span>
<span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">knex</span><span class="p">.</span><span class="nx">schema</span><span class="p">.</span><span class="nx">createTableIfNotExists</span><span class="p">(</span><span class="dl">'</span><span class="s1">users</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">table</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">table</span><span class="p">.</span><span class="nx">increments</span><span class="p">(</span><span class="dl">'</span><span class="s1">id</span><span class="dl">'</span><span class="p">);</span>
  <span class="nx">table</span><span class="p">.</span><span class="nx">string</span><span class="p">(</span><span class="dl">'</span><span class="s1">name</span><span class="dl">'</span><span class="p">);</span>
  <span class="nx">table</span><span class="p">.</span><span class="nx">string</span><span class="p">(</span><span class="dl">'</span><span class="s1">email</span><span class="dl">'</span><span class="p">);</span>
  <span class="nx">table</span><span class="p">.</span><span class="nx">timestamps</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Start the HTTP server</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">startServer</span><span class="p">();</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">API server running at http://localhost:3000/api</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Try: curl http://localhost:3000/api/users</span><span class="dl">'</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="testing-the-api-with-curl">Testing the API with curl</h3>

<p>Once your server is running, you can test it with these curl commands:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Get all users (initially empty)</span>
curl http://localhost:3000/api/users

<span class="c"># Create a new user</span>
curl <span class="nt">-X</span> POST http://localhost:3000/api/users <span class="se">\</span>
  <span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span> <span class="se">\</span>
  <span class="nt">-d</span> <span class="s1">'{
    "data": {
      "type": "users",
      "attributes": {
        "name": "John Doe",
        "email": "john@example.com"
      }
    }
  }'</span>

<span class="c"># Get all users again (should show the created user)</span>
curl http://localhost:3000/api/users

<span class="c"># Get a specific user</span>
curl http://localhost:3000/api/users/1

<span class="c"># Update a user</span>
curl <span class="nt">-X</span> PATCH http://localhost:3000/api/users/1 <span class="se">\</span>
  <span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span> <span class="se">\</span>
  <span class="nt">-d</span> <span class="s1">'{
    "data": {
      "type": "users",
      "id": "1",
      "attributes": {
        "name": "John Smith"
      }
    }
  }'</span>

<span class="c"># Delete a user</span>
curl <span class="nt">-X</span> DELETE http://localhost:3000/api/users/1
</code></pre></div></div>

<h3 id="using-environment-variables">Using Environment Variables</h3>

<p>For production deployments, use environment variables to store sensitive credentials:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Load environment variables (using dotenv package)</span>
<span class="k">import</span> <span class="nx">dotenv</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">dotenv</span><span class="dl">'</span><span class="p">;</span>
<span class="nx">dotenv</span><span class="p">.</span><span class="nx">config</span><span class="p">();</span>

<span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">knex</span><span class="p">({</span>
  <span class="na">client</span><span class="p">:</span> <span class="dl">'</span><span class="s1">mysql2</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">connection</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">host</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_HOST</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">localhost</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">port</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_PORT</span> <span class="o">||</span> <span class="mi">3306</span><span class="p">,</span>
    <span class="na">user</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_USER</span><span class="p">,</span>
    <span class="na">password</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_PASSWORD</span><span class="p">,</span>
    <span class="na">database</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_NAME</span>
  <span class="p">},</span>
  <span class="na">pool</span><span class="p">:</span> <span class="p">{</span> 
    <span class="na">min</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="na">max</span><span class="p">:</span> <span class="mi">10</span> 
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Create a <code class="language-plaintext highlighter-rouge">.env</code> file (remember to add it to <code class="language-plaintext highlighter-rouge">.gitignore</code>):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DB_HOST=localhost
DB_PORT=3306
DB_USER=myapp_user
DB_PASSWORD=secret_password
DB_NAME=myapp_db
</code></pre></div></div>

<h3 id="connection-url-format">Connection URL Format</h3>

<p>You can also use a connection URL:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">knex</span><span class="p">({</span>
  <span class="na">client</span><span class="p">:</span> <span class="dl">'</span><span class="s1">mysql2</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">connection</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DATABASE_URL</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">mysql://user:pass@localhost:3306/dbname</span><span class="dl">'</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="advanced-mysql-configuration">Advanced MySQL Configuration</h3>

<p>For production environments, consider these additional options:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">knex</span><span class="p">({</span>
  <span class="na">client</span><span class="p">:</span> <span class="dl">'</span><span class="s1">mysql2</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">connection</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">host</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_HOST</span><span class="p">,</span>
    <span class="na">port</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_PORT</span><span class="p">,</span>
    <span class="na">user</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_USER</span><span class="p">,</span>
    <span class="na">password</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_PASSWORD</span><span class="p">,</span>
    <span class="na">database</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_NAME</span><span class="p">,</span>
    <span class="na">ssl</span><span class="p">:</span> <span class="p">{</span>
      <span class="c1">// For MySQL servers with SSL/TLS</span>
      <span class="na">rejectUnauthorized</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="na">ca</span><span class="p">:</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="dl">'</span><span class="s1">path/to/ca.pem</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="na">timezone</span><span class="p">:</span> <span class="dl">'</span><span class="s1">UTC</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">charset</span><span class="p">:</span> <span class="dl">'</span><span class="s1">utf8mb4</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">connectTimeout</span><span class="p">:</span> <span class="mi">60000</span><span class="p">,</span>  <span class="c1">// 60 seconds</span>
    <span class="na">stringifyObjects</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="na">multipleStatements</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">},</span>
  <span class="na">pool</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">min</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="na">max</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="na">createTimeoutMillis</span><span class="p">:</span> <span class="mi">30000</span><span class="p">,</span>
    <span class="na">acquireTimeoutMillis</span><span class="p">:</span> <span class="mi">30000</span><span class="p">,</span>
    <span class="na">idleTimeoutMillis</span><span class="p">:</span> <span class="mi">30000</span><span class="p">,</span>
    <span class="na">reapIntervalMillis</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="na">createRetryIntervalMillis</span><span class="p">:</span> <span class="mi">100</span>
  <span class="p">},</span>
  <span class="na">acquireConnectionTimeout</span><span class="p">:</span> <span class="mi">60000</span><span class="p">,</span>
  <span class="na">debug</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">development</span><span class="dl">'</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="creating-tables">Creating Tables</h3>

<p>Once connected, you can create tables using Knex migrations or directly:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Create a books table</span>
<span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">knex</span><span class="p">.</span><span class="nx">schema</span><span class="p">.</span><span class="nx">createTable</span><span class="p">(</span><span class="dl">'</span><span class="s1">books</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">table</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">table</span><span class="p">.</span><span class="nx">increments</span><span class="p">(</span><span class="dl">'</span><span class="s1">id</span><span class="dl">'</span><span class="p">).</span><span class="nx">primary</span><span class="p">();</span>
  <span class="nx">table</span><span class="p">.</span><span class="nx">string</span><span class="p">(</span><span class="dl">'</span><span class="s1">title</span><span class="dl">'</span><span class="p">,</span> <span class="mi">255</span><span class="p">).</span><span class="nx">notNullable</span><span class="p">();</span>
  <span class="nx">table</span><span class="p">.</span><span class="nx">string</span><span class="p">(</span><span class="dl">'</span><span class="s1">author</span><span class="dl">'</span><span class="p">,</span> <span class="mi">255</span><span class="p">).</span><span class="nx">notNullable</span><span class="p">();</span>
  <span class="nx">table</span><span class="p">.</span><span class="nx">integer</span><span class="p">(</span><span class="dl">'</span><span class="s1">year</span><span class="dl">'</span><span class="p">).</span><span class="nx">unsigned</span><span class="p">();</span>
  <span class="nx">table</span><span class="p">.</span><span class="nx">string</span><span class="p">(</span><span class="dl">'</span><span class="s1">isbn</span><span class="dl">'</span><span class="p">,</span> <span class="mi">20</span><span class="p">).</span><span class="nx">unique</span><span class="p">();</span>
  <span class="nx">table</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="dl">'</span><span class="s1">description</span><span class="dl">'</span><span class="p">);</span>
  <span class="nx">table</span><span class="p">.</span><span class="nx">decimal</span><span class="p">(</span><span class="dl">'</span><span class="s1">price</span><span class="dl">'</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
  <span class="nx">table</span><span class="p">.</span><span class="nx">boolean</span><span class="p">(</span><span class="dl">'</span><span class="s1">in_stock</span><span class="dl">'</span><span class="p">).</span><span class="nx">defaultTo</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
  <span class="nx">table</span><span class="p">.</span><span class="nx">timestamps</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>  <span class="c1">// created_at, updated_at</span>
  
  <span class="c1">// Indexes for better query performance</span>
  <span class="nx">table</span><span class="p">.</span><span class="nx">index</span><span class="p">([</span><span class="dl">'</span><span class="s1">author</span><span class="dl">'</span><span class="p">]);</span>
  <span class="nx">table</span><span class="p">.</span><span class="nx">index</span><span class="p">([</span><span class="dl">'</span><span class="s1">year</span><span class="dl">'</span><span class="p">]);</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="complete-example-with-mysql">Complete Example with MySQL</h3>

<p>Here’s a complete working example:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Api</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">hooked-api</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">RestApiPlugin</span><span class="p">,</span> <span class="nx">RestApiKnexPlugin</span><span class="p">,</span> <span class="nx">HttpPlugin</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">json-rest-api</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">knex</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">knex</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">dotenv</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">dotenv</span><span class="dl">'</span><span class="p">;</span>

<span class="c1">// Load environment variables</span>
<span class="nx">dotenv</span><span class="p">.</span><span class="nx">config</span><span class="p">();</span>

<span class="c1">// Configure MySQL connection</span>
<span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">knex</span><span class="p">({</span>
  <span class="na">client</span><span class="p">:</span> <span class="dl">'</span><span class="s1">mysql2</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">connection</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">host</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_HOST</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">localhost</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">port</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_PORT</span> <span class="o">||</span> <span class="mi">3306</span><span class="p">,</span>
    <span class="na">user</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_USER</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">root</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">password</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_PASSWORD</span> <span class="o">||</span> <span class="dl">''</span><span class="p">,</span>
    <span class="na">database</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_NAME</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">bookstore</span><span class="dl">'</span>
  <span class="p">},</span>
  <span class="na">pool</span><span class="p">:</span> <span class="p">{</span> <span class="na">min</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="na">max</span><span class="p">:</span> <span class="mi">10</span> <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// Create API instance</span>
<span class="kd">const</span> <span class="nx">api</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Api</span><span class="p">({</span> <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">bookstore-api</span><span class="dl">'</span> <span class="p">});</span>

<span class="c1">// Install plugins</span>
<span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">RestApiPlugin</span><span class="p">);</span>
<span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">RestApiKnexPlugin</span><span class="p">,</span> <span class="p">{</span> <span class="na">knex</span><span class="p">:</span> <span class="nx">db</span> <span class="p">});</span>
<span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">HttpPlugin</span><span class="p">);</span>

<span class="c1">// Define the books resource with filtering</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">addResource</span><span class="p">(</span><span class="dl">'</span><span class="s1">books</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">schema</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">id</span><span class="dl">'</span> <span class="p">},</span>
    <span class="na">title</span><span class="p">:</span> <span class="p">{</span> 
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">,</span> 
      <span class="na">required</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="na">search</span><span class="p">:</span> <span class="p">{</span> <span class="na">filterUsing</span><span class="p">:</span> <span class="dl">'</span><span class="s1">like</span><span class="dl">'</span> <span class="p">}</span>  <span class="c1">// Enable LIKE filtering</span>
    <span class="p">},</span>
    <span class="na">author</span><span class="p">:</span> <span class="p">{</span> 
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">,</span> 
      <span class="na">required</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="na">search</span><span class="p">:</span> <span class="kc">true</span>  <span class="c1">// Enable exact match filtering</span>
    <span class="p">},</span>
    <span class="na">year</span><span class="p">:</span> <span class="p">{</span> 
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">number</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">search</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">year_min</span><span class="p">:</span> <span class="p">{</span> <span class="na">filterUsing</span><span class="p">:</span> <span class="dl">'</span><span class="s1">&gt;=</span><span class="dl">'</span> <span class="p">},</span>
        <span class="na">year_max</span><span class="p">:</span> <span class="p">{</span> <span class="na">filterUsing</span><span class="p">:</span> <span class="dl">'</span><span class="s1">&lt;=</span><span class="dl">'</span> <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="na">price</span><span class="p">:</span> <span class="p">{</span> 
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">decimal</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">search</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">},</span>
    <span class="na">in_stock</span><span class="p">:</span> <span class="p">{</span> 
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">boolean</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">search</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="na">sortableFields</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">title</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">author</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">year</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">price</span><span class="dl">'</span><span class="p">],</span>
  <span class="na">tableName</span><span class="p">:</span> <span class="dl">'</span><span class="s1">books</span><span class="dl">'</span>  <span class="c1">// Explicitly set table name (optional)</span>
<span class="p">});</span>

<span class="c1">// Start the HTTP server</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">startServer</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">API running at http://localhost:3000/api</span><span class="dl">'</span><span class="p">);</span>

<span class="c1">// Test the database connection</span>
<span class="k">try</span> <span class="p">{</span>
  <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">raw</span><span class="p">(</span><span class="dl">'</span><span class="s1">SELECT 1+1 AS result</span><span class="dl">'</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Database connected successfully</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Database connection failed:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="troubleshooting-mysql-connections">Troubleshooting MySQL Connections</h3>

<p>Common issues and solutions:</p>

<ol>
  <li><strong>Authentication Error</strong>: If you get “ER_NOT_SUPPORTED_AUTH_MODE”, your MySQL 8.0 server might be using the newer authentication plugin. Fix:
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">USER</span> <span class="s1">'your_user'</span><span class="o">@</span><span class="s1">'localhost'</span> <span class="n">IDENTIFIED</span> <span class="k">WITH</span> <span class="n">mysql_native_password</span> <span class="k">BY</span> <span class="s1">'your_password'</span><span class="p">;</span>
<span class="n">FLUSH</span> <span class="k">PRIVILEGES</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>Connection Timeout</strong>: Increase the <code class="language-plaintext highlighter-rouge">connectTimeout</code> in your configuration.</p>
  </li>
  <li><strong>SSL/TLS Issues</strong>: For cloud MySQL instances (AWS RDS, Google Cloud SQL), you may need to configure SSL:
    <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">connection</span><span class="p">:</span> <span class="p">{</span>
  <span class="c1">// ... other config</span>
  <span class="nl">ssl</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">rejectUnauthorized</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">ca</span><span class="p">:</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="dl">'</span><span class="s1">path/to/server-ca.pem</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li><strong>Character Set Issues</strong>: Use <code class="language-plaintext highlighter-rouge">utf8mb4</code> for full Unicode support including emojis:
    <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">connection</span><span class="p">:</span> <span class="p">{</span>
  <span class="c1">// ... other config</span>
  <span class="nl">charset</span><span class="p">:</span> <span class="dl">'</span><span class="s1">utf8mb4</span><span class="dl">'</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="direct-database-access">Direct Database Access</h3>

<p>The plugin exposes the Knex instance as <code class="language-plaintext highlighter-rouge">api.knex</code>, allowing you to run complex queries directly:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Complex query with joins</span>
<span class="kd">const</span> <span class="nx">results</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">knex</span><span class="p">(</span><span class="dl">'</span><span class="s1">books</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="dl">'</span><span class="s1">authors</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">books.author_id</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">authors.id</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="dl">'</span><span class="s1">books.*</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">authors.name as author_name</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="dl">'</span><span class="s1">books.year</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">&gt;</span><span class="dl">'</span><span class="p">,</span> <span class="mi">2020</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">orderBy</span><span class="p">(</span><span class="dl">'</span><span class="s1">books.created_at</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">desc</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

<span class="c1">// Raw SQL queries</span>
<span class="kd">const</span> <span class="nx">stats</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">knex</span><span class="p">.</span><span class="nx">raw</span><span class="p">(</span><span class="s2">`
  SELECT 
    COUNT(*) as total_books,
    AVG(price) as avg_price,
    MAX(price) as max_price
  FROM books
  WHERE in_stock = ?
`</span><span class="p">,</span> <span class="p">[</span><span class="kc">true</span><span class="p">]);</span>

<span class="c1">// Transactions</span>
<span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">knex</span><span class="p">.</span><span class="nx">transaction</span><span class="p">(</span><span class="k">async</span> <span class="p">(</span><span class="nx">trx</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">authorId</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">trx</span><span class="p">(</span><span class="dl">'</span><span class="s1">authors</span><span class="dl">'</span><span class="p">).</span><span class="nx">insert</span><span class="p">({</span> <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">New Author</span><span class="dl">'</span> <span class="p">});</span>
  <span class="k">await</span> <span class="nx">trx</span><span class="p">(</span><span class="dl">'</span><span class="s1">books</span><span class="dl">'</span><span class="p">).</span><span class="nx">insert</span><span class="p">({</span>
    <span class="na">title</span><span class="p">:</span> <span class="dl">'</span><span class="s1">New Book</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">author_id</span><span class="p">:</span> <span class="nx">authorId</span><span class="p">,</span>
    <span class="na">year</span><span class="p">:</span> <span class="mi">2024</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>With this configuration, your REST API will automatically use MySQL for all database operations, with full support for filtering, sorting, and pagination as described in the previous sections.</p>

<h3 id="advanced-filtering-with-hooks">Advanced Filtering with Hooks</h3>

<p>The REST API Knex Plugin supports extensible filtering through hooks. When adding custom filters, always use grouping to prevent accidental security bypasses:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Add a tenant isolation filter</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">addHook</span><span class="p">(</span><span class="dl">'</span><span class="s1">knexQueryFiltering</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">tenantFilter</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">order</span><span class="p">:</span> <span class="o">-</span><span class="mi">100</span> <span class="p">},</span> <span class="p">({</span> <span class="nx">query</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">query</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="dl">'</span><span class="s1">tenant_id</span><span class="dl">'</span><span class="p">,</span> <span class="nx">getCurrentTenant</span><span class="p">());</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="dl">'</span><span class="s1">deleted_at</span><span class="dl">'</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>

<span class="c1">// Add a complex search filter</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">addHook</span><span class="p">(</span><span class="dl">'</span><span class="s1">knexQueryFiltering</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">searchFilter</span><span class="dl">'</span><span class="p">,</span> <span class="p">{},</span> <span class="p">({</span> <span class="nx">query</span><span class="p">,</span> <span class="nx">filters</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">filters</span><span class="p">.</span><span class="nx">search</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">query</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">term</span> <span class="o">=</span> <span class="s2">`%</span><span class="p">${</span><span class="nx">filters</span><span class="p">.</span><span class="nx">search</span><span class="p">}</span><span class="s2">%`</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="dl">'</span><span class="s1">title</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">like</span><span class="dl">'</span><span class="p">,</span> <span class="nx">term</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">orWhere</span><span class="p">(</span><span class="dl">'</span><span class="s1">description</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">like</span><span class="dl">'</span><span class="p">,</span> <span class="nx">term</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">orWhere</span><span class="p">(</span><span class="dl">'</span><span class="s1">tags</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">like</span><span class="dl">'</span><span class="p">,</span> <span class="nx">term</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// Add region-based filtering</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">addHook</span><span class="p">(</span><span class="dl">'</span><span class="s1">knexQueryFiltering</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">regionFilter</span><span class="dl">'</span><span class="p">,</span> <span class="p">{},</span> <span class="p">({</span> <span class="nx">query</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">query</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">userRegion</span> <span class="o">=</span> <span class="nx">getUserRegion</span><span class="p">();</span>
    <span class="c1">// Show items from user's region, global items, or items without a region</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="dl">'</span><span class="s1">region</span><span class="dl">'</span><span class="p">,</span> <span class="nx">userRegion</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">orWhere</span><span class="p">(</span><span class="dl">'</span><span class="s1">region</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">global</span><span class="dl">'</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">orWhereNull</span><span class="p">(</span><span class="dl">'</span><span class="s1">region</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>These filters will be combined with AND, ensuring that security filters cannot be bypassed:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">WHERE (tenant_id = 123 AND deleted_at IS NULL) AND (title LIKE '%search%' OR description LIKE '%search%' OR tags LIKE '%search%') AND (region = 'US' OR region = 'global' OR region IS NULL)</code></li>
</ul>

<p><strong>Important</strong>: Always wrap your filter conditions in <code class="language-plaintext highlighter-rouge">query.where(function() { ... })</code> to ensure proper grouping. This prevents OR conditions from accidentally bypassing other filters.</p>

<h2 id="many-to-many-relationships">Many-to-Many Relationships</h2>

<p>Many-to-many relationships require a pivot table. In the JSON REST API system, the pivot table is treated as a full resource with its own schema and endpoints.</p>

<h3 id="understanding-relationships-and-side-loading">Understanding Relationships and Side-Loading</h3>

<p>Before diving into many-to-many relationships, it’s important to understand how relationships work in the JSON REST API system and the side-loading functionality.</p>

<h4 id="relationship-types">Relationship Types</h4>

<p>The system supports three types of relationships:</p>

<ol>
  <li><strong>belongsTo</strong> (Many-to-One) - A foreign key relationship where a resource belongs to another resource</li>
  <li><strong>hasMany</strong> (One-to-Many) - The inverse of belongsTo, where a resource has many related resources</li>
  <li><strong>hasMany with through</strong> (Many-to-Many) - A relationship through a pivot/junction table</li>
</ol>

<h4 id="side-loading-with-include-parameter">Side-Loading with Include Parameter</h4>

<p>Side-loading allows you to fetch related resources in a single request using the <code class="language-plaintext highlighter-rouge">include</code> query parameter. This follows the JSON:API specification and helps prevent N+1 query problems.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Example: Get a book with its author included</span>
<span class="nx">GET</span> <span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">books</span><span class="o">/</span><span class="mi">1</span><span class="p">?</span><span class="nx">include</span><span class="o">=</span><span class="nx">author</span>

<span class="c1">// Example: Get a book with nested includes</span>
<span class="nx">GET</span> <span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">books</span><span class="o">/</span><span class="mi">1</span><span class="p">?</span><span class="nx">include</span><span class="o">=</span><span class="nx">author</span><span class="p">.</span><span class="nx">company</span><span class="p">,</span><span class="nx">reviews</span><span class="p">.</span><span class="nx">reviewer</span>
</code></pre></div></div>

<h4 id="configuring-side-load-behavior">Configuring Side-Load Behavior</h4>

<p>The side-loading functionality is controlled by the following properties in your relationship definitions:</p>

<h5 id="for-belongsto-relationships">For belongsTo Relationships</h5>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">sideLoadSingle</code></strong> (default: <code class="language-plaintext highlighter-rouge">true</code>) - Controls whether the related resource can be included via the <code class="language-plaintext highlighter-rouge">include</code> parameter</li>
  <li><strong><code class="language-plaintext highlighter-rouge">sideSearchSingle</code></strong> (default: <code class="language-plaintext highlighter-rouge">true</code>) - Controls whether you can filter parent resources by fields in the related resource</li>
</ul>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">api</span><span class="p">.</span><span class="nx">addResource</span><span class="p">(</span><span class="dl">'</span><span class="s1">books</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">schema</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">author_id</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">belongsTo</span><span class="p">:</span> <span class="dl">'</span><span class="s1">authors</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">as</span><span class="p">:</span> <span class="dl">'</span><span class="s1">author</span><span class="dl">'</span><span class="p">,</span>
      <span class="c1">// sideLoadSingle: true,  // Default - can be omitted</span>
      <span class="c1">// sideSearchSingle: true  // Default - can be omitted</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// This allows:</span>
<span class="c1">// GET /api/books?include=author</span>
<span class="c1">// GET /api/books?filter[authorName]=Tolkien (with appropriate searchSchema)</span>
</code></pre></div></div>

<h5 id="for-hasmany-relationships">For hasMany Relationships</h5>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">canSideLoadMany</code></strong> (default: <code class="language-plaintext highlighter-rouge">false</code>) - Controls whether related resources can be included</li>
  <li><strong><code class="language-plaintext highlighter-rouge">sideSearchMany</code></strong> (default: <code class="language-plaintext highlighter-rouge">false</code>) - Controls whether you can filter by related resources</li>
</ul>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">api</span><span class="p">.</span><span class="nx">addResource</span><span class="p">(</span><span class="dl">'</span><span class="s1">authors</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">schema</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">id</span><span class="dl">'</span> <span class="p">},</span>
    <span class="na">name</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span> <span class="p">}</span>
  <span class="p">},</span>
  <span class="na">relationships</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">books</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">hasMany</span><span class="p">:</span> <span class="dl">'</span><span class="s1">books</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">foreignKey</span><span class="p">:</span> <span class="dl">'</span><span class="s1">author_id</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">canSideLoadMany</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>    <span class="c1">// Must be explicitly enabled</span>
      <span class="na">sideSearchMany</span><span class="p">:</span> <span class="kc">true</span>   <span class="c1">// Must be explicitly enabled</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// This allows:</span>
<span class="c1">// GET /api/authors/1?include=books</span>
<span class="c1">// GET /api/authors?filter[bookTitle]=Hobbit (with appropriate searchSchema)</span>
</code></pre></div></div>

<h5 id="for-many-to-many-relationships">For Many-to-Many Relationships</h5>

<p>Many-to-many relationships using <code class="language-plaintext highlighter-rouge">hasMany</code> with <code class="language-plaintext highlighter-rouge">through</code> also use <code class="language-plaintext highlighter-rouge">canSideLoadMany</code>:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">api</span><span class="p">.</span><span class="nx">addResource</span><span class="p">(</span><span class="dl">'</span><span class="s1">books</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">schema</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">id</span><span class="dl">'</span> <span class="p">},</span>
    <span class="na">title</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span> <span class="p">}</span>
  <span class="p">},</span>
  <span class="na">relationships</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">tags</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">hasMany</span><span class="p">:</span> <span class="dl">'</span><span class="s1">tags</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">through</span><span class="p">:</span> <span class="dl">'</span><span class="s1">book_tags</span><span class="dl">'</span><span class="p">,</span>    <span class="c1">// Pivot table</span>
      <span class="na">foreignKey</span><span class="p">:</span> <span class="dl">'</span><span class="s1">book_id</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">otherKey</span><span class="p">:</span> <span class="dl">'</span><span class="s1">tag_id</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">canSideLoadMany</span><span class="p">:</span> <span class="kc">true</span>       <span class="c1">// Enable including tags</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// This allows:</span>
<span class="c1">// GET /api/books/1?include=tags</span>
</code></pre></div></div>

<h4 id="important-notes-on-side-loading">Important Notes on Side-Loading</h4>

<ol>
  <li>
    <p><strong>Performance Consideration</strong>: hasMany relationships have <code class="language-plaintext highlighter-rouge">canSideLoadMany</code> disabled by default because including many related resources can impact performance. Enable it only when needed.</p>
  </li>
  <li><strong>Nested Includes</strong>: You can include nested relationships using dot notation:
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /api/books/1?include=author.company,reviews.reviewer.department
</code></pre></div>    </div>
  </li>
  <li><strong>Sparse Fieldsets</strong>: Combine includes with sparse fieldsets to fetch only needed fields:
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /api/books/1?include=author&amp;fields[authors]=name,email
</code></pre></div>    </div>
  </li>
  <li><strong>Cross-Table Search</strong>: When <code class="language-plaintext highlighter-rouge">sideSearchSingle</code> or <code class="language-plaintext highlighter-rouge">sideSearchMany</code> is enabled, you can define searchSchema fields that reference related tables:
    <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">api</span><span class="p">.</span><span class="nx">addResource</span><span class="p">(</span><span class="dl">'</span><span class="s1">books</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">schema</span><span class="p">:</span> <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">},</span>
  <span class="na">searchSchema</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">authorName</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">actualField</span><span class="p">:</span> <span class="dl">'</span><span class="s1">authors.name</span><span class="dl">'</span><span class="p">,</span>  <span class="c1">// Reference field in related table</span>
      <span class="na">filterUsing</span><span class="p">:</span> <span class="dl">'</span><span class="s1">like</span><span class="dl">'</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="books-with-multiple-authors-example">Books with Multiple Authors Example</h3>

<p>Let’s update our books example to support multiple authors. Previously, books had a single <code class="language-plaintext highlighter-rouge">author</code> field. Now we’ll create a many-to-many relationship between <code class="language-plaintext highlighter-rouge">books</code> and <code class="language-plaintext highlighter-rouge">people</code> (authors).</p>

<h4 id="step-1-define-the-pivot-resource">Step 1: Define the Pivot Resource</h4>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Define the book_authors pivot table as a resource</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">addResource</span><span class="p">(</span><span class="dl">'</span><span class="s1">book_authors</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">schema</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">id</span><span class="dl">'</span> <span class="p">},</span>
    <span class="na">book_id</span><span class="p">:</span> <span class="p">{</span> 
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">number</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">belongsTo</span><span class="p">:</span> <span class="dl">'</span><span class="s1">books</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">as</span><span class="p">:</span> <span class="dl">'</span><span class="s1">book</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">sideSearchSingle</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">},</span>
    <span class="na">author_id</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">number</span><span class="dl">'</span><span class="p">,</span> 
      <span class="na">belongsTo</span><span class="p">:</span> <span class="dl">'</span><span class="s1">people</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">as</span><span class="p">:</span> <span class="dl">'</span><span class="s1">author</span><span class="dl">'</span><span class="p">,</span>
      <span class="c1">// sideLoadSingle: true,  // Default for belongsTo - can be omitted</span>
      <span class="na">sideSearchSingle</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">},</span>
    <span class="na">author_order</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">number</span><span class="dl">'</span> <span class="p">},</span> <span class="c1">// Display order for multiple authors</span>
    <span class="na">contribution_type</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span> <span class="p">}</span> <span class="c1">// 'primary', 'co-author', 'contributor'</span>
  <span class="p">},</span>
  <span class="na">searchSchema</span><span class="p">:</span> <span class="p">{</span>
    <span class="c1">// Search by book title</span>
    <span class="na">bookTitle</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">actualField</span><span class="p">:</span> <span class="dl">'</span><span class="s1">books.title</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">filterUsing</span><span class="p">:</span> <span class="dl">'</span><span class="s1">like</span><span class="dl">'</span>
    <span class="p">},</span>
    <span class="c1">// Search by author name</span>
    <span class="na">authorName</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">actualField</span><span class="p">:</span> <span class="dl">'</span><span class="s1">people.name</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">filterUsing</span><span class="p">:</span> <span class="dl">'</span><span class="s1">like</span><span class="dl">'</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<h4 id="step-2-update-books-and-people-resources">Step 2: Update Books and People Resources</h4>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Update books resource (remove single author field)</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">addResource</span><span class="p">(</span><span class="dl">'</span><span class="s1">books</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">schema</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">id</span><span class="dl">'</span> <span class="p">},</span>
    <span class="na">title</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">indexed</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
    <span class="na">year</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">number</span><span class="dl">'</span> <span class="p">},</span>
    <span class="na">isbn</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span> <span class="p">}</span>
    <span class="c1">// Note: removed 'author' field - now using many-to-many</span>
  <span class="p">},</span>
  <span class="na">relationships</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">authors</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">hasMany</span><span class="p">:</span> <span class="dl">'</span><span class="s1">book_authors</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">foreignKey</span><span class="p">:</span> <span class="dl">'</span><span class="s1">book_id</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">as</span><span class="p">:</span> <span class="dl">'</span><span class="s1">authors</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">canSideLoadMany</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// Define people resource</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">addResource</span><span class="p">(</span><span class="dl">'</span><span class="s1">people</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">schema</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">id</span><span class="dl">'</span> <span class="p">},</span>
    <span class="na">name</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">indexed</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
    <span class="na">email</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span> <span class="p">}</span>
  <span class="p">},</span>
  <span class="na">relationships</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">books</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">hasMany</span><span class="p">:</span> <span class="dl">'</span><span class="s1">book_authors</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">foreignKey</span><span class="p">:</span> <span class="dl">'</span><span class="s1">author_id</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">as</span><span class="p">:</span> <span class="dl">'</span><span class="s1">books</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">canSideLoadMany</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="using-many-to-many-relationships">Using Many-to-Many Relationships</h3>

<h4 id="new-creating-books-with-authors-in-one-request">NEW: Creating Books with Authors in One Request</h4>

<p>With the enhanced POST implementation, you can now create a book and establish many-to-many relationships in a single atomic request:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// First, define the pivot table resource (with searchable fields for updates)</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">addResource</span><span class="p">(</span><span class="dl">'</span><span class="s1">book_tags</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">schema</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">id</span><span class="dl">'</span> <span class="p">},</span>
    <span class="na">book_id</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">number</span><span class="dl">'</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">search</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
    <span class="na">tag_id</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">number</span><span class="dl">'</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">search</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">// Note: You can also define these in a separate searchSchema instead:</span>
  <span class="c1">// searchSchema: {</span>
  <span class="c1">//   book_id: { type: 'number' },</span>
  <span class="c1">//   tag_id: { type: 'number' }</span>
  <span class="c1">// }</span>
<span class="p">});</span>

<span class="c1">// Then define the tags resource</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">addResource</span><span class="p">(</span><span class="dl">'</span><span class="s1">tags</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">schema</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">id</span><span class="dl">'</span> <span class="p">},</span>
    <span class="na">name</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// Finally, define the books resource with the many-to-many relationship</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">addResource</span><span class="p">(</span><span class="dl">'</span><span class="s1">books</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">schema</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">id</span><span class="dl">'</span> <span class="p">},</span>
    <span class="na">title</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
    <span class="na">year</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">number</span><span class="dl">'</span> <span class="p">}</span>
  <span class="p">},</span>
  <span class="na">relationships</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">tags</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">hasMany</span><span class="p">:</span> <span class="dl">'</span><span class="s1">tags</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">through</span><span class="p">:</span> <span class="dl">'</span><span class="s1">book_tags</span><span class="dl">'</span><span class="p">,</span>      <span class="c1">// Pivot table resource</span>
      <span class="na">foreignKey</span><span class="p">:</span> <span class="dl">'</span><span class="s1">book_id</span><span class="dl">'</span><span class="p">,</span>     <span class="c1">// Key for this resource</span>
      <span class="na">otherKey</span><span class="p">:</span> <span class="dl">'</span><span class="s1">tag_id</span><span class="dl">'</span>         <span class="c1">// Key for related resource</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// Create book with tags in one request</span>
<span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">api</span><span class="p">.</span><span class="nx">resources</span><span class="p">.</span><span class="nx">books</span><span class="p">.</span><span class="nx">post</span><span class="p">({</span>
  <span class="na">inputRecord</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">data</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">books</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">attributes</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Good Omens</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">year</span><span class="dl">"</span><span class="p">:</span> <span class="mi">1990</span>
      <span class="p">},</span>
      <span class="dl">"</span><span class="s2">relationships</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">tags</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
          <span class="dl">"</span><span class="s2">data</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span> <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">tags</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">1</span><span class="dl">"</span> <span class="p">},</span>  <span class="c1">// Must be existing tags</span>
            <span class="p">{</span> <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">tags</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">2</span><span class="dl">"</span> <span class="p">}</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<p>This will atomically:</p>
<ol>
  <li>Create the book</li>
  <li>Create entries in the <code class="language-plaintext highlighter-rouge">book_tags</code> pivot table</li>
  <li>Return the book with its relationships</li>
</ol>

<h4 id="traditional-method-creating-relationships-separately">Traditional Method: Creating Relationships Separately</h4>

<p>Alternatively, you can still use the traditional approach:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># First, create a book</span>
curl <span class="nt">-X</span> POST http://localhost:3000/api/books <span class="se">\</span>
  <span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span> <span class="se">\</span>
  <span class="nt">-d</span> <span class="s1">'{
    "data": {
      "type": "books",
      "attributes": {
        "title": "Good Omens",
        "year": 1990
      }
    }
  }'</span>

<span class="c"># Then link authors to the book via pivot table</span>
curl <span class="nt">-X</span> POST http://localhost:3000/api/book_authors <span class="se">\</span>
  <span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span> <span class="se">\</span>
  <span class="nt">-d</span> <span class="s1">'{
    "data": {
      "type": "book_authors",
      "attributes": {
        "author_order": 1,
        "contribution_type": "co-author"
      },
      "relationships": {
        "book": { "data": { "type": "books", "id": "1" } },
        "author": { "data": { "type": "people", "id": "1" } }
      }
    }
  }'</span>
</code></pre></div></div>

<h4 id="querying-books-with-authors">Querying Books with Authors</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Get a book with all its authors</span>
curl <span class="s2">"http://localhost:3000/api/books/1?include=authors.author"</span>

<span class="c"># Search for books by author name</span>
curl <span class="s2">"http://localhost:3000/api/book_authors?filter[authorName]=Fitzgerald&amp;include=book"</span>

<span class="c"># Get all books by a specific author</span>
curl <span class="s2">"http://localhost:3000/api/people/1?include=books.book"</span>
</code></pre></div></div>

<h4 id="example-response">Example Response</h4>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"books"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Good Omens"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"year"</span><span class="p">:</span><span class="w"> </span><span class="mi">1990</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"relationships"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"authors"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"book_authors"</span><span class="p">,</span><span class="w"> </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"book_authors"</span><span class="p">,</span><span class="w"> </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2"</span><span class="w"> </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"included"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"book_authors"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"author_order"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"contribution_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"co-author"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"relationships"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"author"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"people"</span><span class="p">,</span><span class="w"> </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"10"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"book_authors"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"author_order"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
        </span><span class="nl">"contribution_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"co-author"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"relationships"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"author"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"people"</span><span class="p">,</span><span class="w"> </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"11"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"people"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"10"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Terry Pratchett"</span><span class="w"> </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"people"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"11"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Neil Gaiman"</span><span class="w"> </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="polymorphic-relationships">Polymorphic Relationships</h2>

<p>Polymorphic relationships allow a model to belong to multiple other models using a single association.</p>

<h3 id="comments-example">Comments Example</h3>

<p>Let’s add a commenting system where comments can be attached to books or articles.</p>

<h4 id="define-comments-with-polymorphic-relationship">Define Comments with Polymorphic Relationship</h4>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">api</span><span class="p">.</span><span class="nx">addResource</span><span class="p">(</span><span class="dl">'</span><span class="s1">comments</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">schema</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">id</span><span class="dl">'</span> <span class="p">},</span>
    <span class="na">body</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
    <span class="na">user_id</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">number</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">belongsTo</span><span class="p">:</span> <span class="dl">'</span><span class="s1">people</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">as</span><span class="p">:</span> <span class="dl">'</span><span class="s1">author</span><span class="dl">'</span>
      <span class="c1">// sideLoadSingle: true  // Default for belongsTo - can be omitted</span>
    <span class="p">},</span>
    <span class="c1">// Polymorphic relationship - defines both the relationship and the fields</span>
    <span class="na">commentable</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">belongsToPolymorphic</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">types</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">books</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">articles</span><span class="dl">'</span><span class="p">],</span>
        <span class="na">typeField</span><span class="p">:</span> <span class="dl">'</span><span class="s1">commentable_type</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">idField</span><span class="p">:</span> <span class="dl">'</span><span class="s1">commentable_id</span><span class="dl">'</span>
      <span class="p">},</span>
      <span class="na">as</span><span class="p">:</span> <span class="dl">'</span><span class="s1">commentable</span><span class="dl">'</span>
      <span class="c1">// sideLoadSingle: true  // Default for belongsToPolymorphic - can be omitted</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="na">searchSchema</span><span class="p">:</span> <span class="p">{</span>
    <span class="c1">// Search by title of the commented item</span>
    <span class="na">commentableTitle</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">filterUsing</span><span class="p">:</span> <span class="dl">'</span><span class="s1">like</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">polymorphicField</span><span class="p">:</span> <span class="dl">'</span><span class="s1">commentable</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">targetFields</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">books</span><span class="p">:</span> <span class="dl">'</span><span class="s1">title</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">articles</span><span class="p">:</span> <span class="dl">'</span><span class="s1">title</span><span class="dl">'</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// Add reverse relationship to books</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">addResource</span><span class="p">(</span><span class="dl">'</span><span class="s1">books</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">schema</span><span class="p">:</span> <span class="p">{</span>
    <span class="c1">// ... existing schema ...</span>
  <span class="p">},</span>
  <span class="na">relationships</span><span class="p">:</span> <span class="p">{</span>
    <span class="c1">// ... existing relationships ...</span>
    <span class="na">comments</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">hasMany</span><span class="p">:</span> <span class="dl">'</span><span class="s1">comments</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">via</span><span class="p">:</span> <span class="dl">'</span><span class="s1">commentable</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">as</span><span class="p">:</span> <span class="dl">'</span><span class="s1">comments</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">canSideLoadMany</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// Define articles resource</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">addResource</span><span class="p">(</span><span class="dl">'</span><span class="s1">articles</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">schema</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">id</span><span class="dl">'</span> <span class="p">},</span>
    <span class="na">title</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">indexed</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
    <span class="na">content</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">text</span><span class="dl">'</span> <span class="p">}</span>
  <span class="p">},</span>
  <span class="na">relationships</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">comments</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">hasMany</span><span class="p">:</span> <span class="dl">'</span><span class="s1">comments</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">via</span><span class="p">:</span> <span class="dl">'</span><span class="s1">commentable</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">as</span><span class="p">:</span> <span class="dl">'</span><span class="s1">comments</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">canSideLoadMany</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="using-polymorphic-relationships">Using Polymorphic Relationships</h3>

<h4 id="creating-comments">Creating Comments</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Comment on a book</span>
curl <span class="nt">-X</span> POST http://localhost:3000/api/comments <span class="se">\</span>
  <span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span> <span class="se">\</span>
  <span class="nt">-d</span> <span class="s1">'{
    "data": {
      "type": "comments",
      "attributes": {
        "body": "This book changed my perspective!"
      },
      "relationships": {
        "author": { "data": { "type": "people", "id": "1" } },
        "commentable": { "data": { "type": "books", "id": "1" } }
      }
    }
  }'</span>

<span class="c"># Comment on an article</span>
curl <span class="nt">-X</span> POST http://localhost:3000/api/comments <span class="se">\</span>
  <span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span> <span class="se">\</span>
  <span class="nt">-d</span> <span class="s1">'{
    "data": {
      "type": "comments",
      "attributes": {
        "body": "Great article!"
      },
      "relationships": {
        "author": { "data": { "type": "people", "id": "1" } },
        "commentable": { "data": { "type": "articles", "id": "5" } }
      }
    }
  }'</span>
</code></pre></div></div>

<h4 id="querying-polymorphic-relationships">Querying Polymorphic Relationships</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Get all comments with their parent (book or article)</span>
curl <span class="s2">"http://localhost:3000/api/comments?include=commentable"</span>

<span class="c"># Search comments on items with "REST" in title</span>
curl <span class="s2">"http://localhost:3000/api/comments?filter[commentableTitle]=REST"</span>

<span class="c"># Get all comments for a specific book</span>
curl <span class="s2">"http://localhost:3000/api/books/1?include=comments.author"</span>
</code></pre></div></div>

<h4 id="example-response-1">Example Response</h4>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"comments"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"body"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Great book!"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"relationships"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"commentable"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"books"</span><span class="p">,</span><span class="w"> </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"comments"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"body"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Interesting article!"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"relationships"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"commentable"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"articles"</span><span class="p">,</span><span class="w"> </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"included"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"books"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The Great Gatsby"</span><span class="w"> </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"articles"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Understanding REST APIs"</span><span class="w"> </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="how-polymorphic-search-works">How Polymorphic Search Works</h3>

<p>The system generates conditional JOINs for polymorphic searches:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- GET /comments?filter[commentableTitle]=gatsby</span>
<span class="k">SELECT</span> <span class="n">comments</span><span class="p">.</span><span class="o">*</span> 
<span class="k">FROM</span> <span class="n">comments</span> 
<span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">books</span> <span class="k">AS</span> <span class="n">comments_commentable_books</span> 
  <span class="k">ON</span> <span class="n">comments</span><span class="p">.</span><span class="n">commentable_type</span> <span class="o">=</span> <span class="s1">'books'</span> 
  <span class="k">AND</span> <span class="n">comments</span><span class="p">.</span><span class="n">commentable_id</span> <span class="o">=</span> <span class="n">comments_commentable_books</span><span class="p">.</span><span class="n">id</span>
<span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">articles</span> <span class="k">AS</span> <span class="n">comments_commentable_articles</span> 
  <span class="k">ON</span> <span class="n">comments</span><span class="p">.</span><span class="n">commentable_type</span> <span class="o">=</span> <span class="s1">'articles'</span> 
  <span class="k">AND</span> <span class="n">comments</span><span class="p">.</span><span class="n">commentable_id</span> <span class="o">=</span> <span class="n">comments_commentable_articles</span><span class="p">.</span><span class="n">id</span>
<span class="k">WHERE</span> <span class="p">(</span>
  <span class="p">(</span><span class="n">comments</span><span class="p">.</span><span class="n">commentable_type</span> <span class="o">=</span> <span class="s1">'books'</span> 
   <span class="k">AND</span> <span class="n">comments_commentable_books</span><span class="p">.</span><span class="n">title</span> <span class="k">LIKE</span> <span class="s1">'%gatsby%'</span><span class="p">)</span>
  <span class="k">OR</span> 
  <span class="p">(</span><span class="n">comments</span><span class="p">.</span><span class="n">commentable_type</span> <span class="o">=</span> <span class="s1">'articles'</span> 
   <span class="k">AND</span> <span class="n">comments_commentable_articles</span><span class="p">.</span><span class="n">title</span> <span class="k">LIKE</span> <span class="s1">'%gatsby%'</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div></div>

    </div>
  </main>

  <footer>
    <div class="wrapper">
      <p>JSON REST API &copy; 2025 - MIT License</p>
    </div>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Add copy buttons to all code blocks
      document.querySelectorAll('pre').forEach(function(pre) {
        // Skip if button already exists
        if (pre.querySelector('.copy-button')) return;
        
        const button = document.createElement('button');
        button.className = 'copy-button';
        button.textContent = 'Copy';
        button.addEventListener('click', function() {
          const code = pre.querySelector('code') ? 
            pre.querySelector('code').textContent : 
            pre.textContent;
          
          navigator.clipboard.writeText(code).then(function() {
            button.textContent = '✓ Copied!';
            button.classList.add('copied');
            setTimeout(() => {
              button.textContent = 'Copy';
              button.classList.remove('copied');
            }, 2000);
          }).catch(function() {
            // Fallback for older browsers
            const textarea = document.createElement('textarea');
            textarea.value = code;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            
            button.textContent = '✓ Copied!';
            button.classList.add('copied');
            setTimeout(() => {
              button.textContent = 'Copy';
              button.classList.remove('copied');
            }, 2000);
          });
        });
        pre.appendChild(button);
      });
    });
  </script>
</body>
</html>