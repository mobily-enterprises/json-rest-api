<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>File Uploads Guide - JSON REST API</title>
  <meta name="description" content="A lightweight, plugin-based REST API framework for Node.js">
  <link rel="icon" type="image/svg+xml" href="/json-rest-api/favicon.svg">
  <link rel="apple-touch-icon" href="/json-rest-api/apple-touch-icon.svg">
  <link rel="stylesheet" href="/json-rest-api/assets/css/style.css">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>File Uploads Guide | JSON REST API</title>
<meta name="generator" content="Jekyll v3.9.5" />
<meta property="og:title" content="File Uploads Guide" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A lightweight, plugin-based REST API framework for Node.js" />
<meta property="og:description" content="A lightweight, plugin-based REST API framework for Node.js" />
<link rel="canonical" href="http://localhost:4000/json-rest-api/fileUploads.html" />
<meta property="og:url" content="http://localhost:4000/json-rest-api/fileUploads.html" />
<meta property="og:site_name" content="JSON REST API" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="File Uploads Guide" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"A lightweight, plugin-based REST API framework for Node.js","headline":"File Uploads Guide","url":"http://localhost:4000/json-rest-api/fileUploads.html"}</script>
<!-- End Jekyll SEO tag -->

  <style>
    .highlight {
      position: relative;
    }
    pre {
      position: relative;
    }
    .copy-button {
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 500;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      color: #333;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    .copy-button:hover {
      background: rgba(255, 255, 255, 1);
      border-color: rgba(0, 0, 0, 0.2);
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .copy-button:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    .copy-button.copied {
      background: #10b981;
      color: white;
      border-color: #10b981;
    }
  </style>
</head>
<body>
  <header>
    <div class="wrapper">
      <h1><a href="/json-rest-api/">JSON REST API</a></h1>
      <nav>
        <a href="/json-rest-api/QUICKSTART">Quick Start</a>
        <a href="/json-rest-api/GUIDE">Guide</a>
        <a href="/json-rest-api/API">API Reference</a>
        <a href="/json-rest-api/ONBOARDING">Contribute</a>
        <a href="/json-rest-api/COMPARISON">Why json-rest-api</a>
      </nav>
    </div>
  </header>

  <main>
    <div class="page-content">
      <h1 id="file-uploads-guide">File Uploads Guide</h1>

<p>This guide explains how to handle file uploads in JSON REST API using the FileHandlingPlugin. The system is designed to be protocol-agnostic, storage-pluggable, and schema-driven.</p>

<h2 id="table-of-contents">Table of Contents</h2>

<ol>
  <li><a href="#overview">Overview</a></li>
  <li><a href="#quick-start">Quick Start</a></li>
  <li><a href="#schema-configuration">Schema Configuration</a></li>
  <li><a href="#storage-adapters">Storage Adapters</a></li>
  <li><a href="#protocol-configuration">Protocol Configuration</a></li>
  <li><a href="#file-validation">File Validation</a></li>
  <li><a href="#complete-examples">Complete Examples</a></li>
  <li><a href="#troubleshooting">Troubleshooting</a></li>
</ol>

<h2 id="overview">Overview</h2>

<p>The file handling system consists of three main components:</p>

<ol>
  <li><strong>FileHandlingPlugin</strong> - Orchestrates file detection and processing</li>
  <li><strong>Protocol Detectors</strong> - Parse files from different protocols (HTTP, Express)</li>
  <li><strong>Storage Adapters</strong> - Save files to different backends (local, S3, etc.)</li>
</ol>

<h3 id="how-it-works">How It Works</h3>

<ol>
  <li>You define file fields in your schema with <code class="language-plaintext highlighter-rouge">type: 'file'</code></li>
  <li>Protocol plugins detect and parse multipart uploads</li>
  <li>FileHandlingPlugin validates and processes files</li>
  <li>Storage adapters save files and return URLs</li>
  <li>File fields are replaced with URLs in your data</li>
</ol>

<h2 id="quick-start">Quick Start</h2>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Api</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">hooked-api</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">RestApiPlugin</span><span class="p">,</span> <span class="nx">FileHandlingPlugin</span><span class="p">,</span> <span class="nx">ExpressPlugin</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">json-rest-api</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">LocalStorage</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">json-rest-api/plugins/storage/local-storage.js</span><span class="dl">'</span><span class="p">;</span>

<span class="c1">// Create API</span>
<span class="kd">const</span> <span class="nx">api</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Api</span><span class="p">({</span> <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">my-api</span><span class="dl">'</span><span class="p">,</span> <span class="na">version</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1.0.0</span><span class="dl">'</span> <span class="p">});</span>

<span class="c1">// Create storage</span>
<span class="kd">const</span> <span class="nx">storage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LocalStorage</span><span class="p">({</span>
  <span class="na">directory</span><span class="p">:</span> <span class="dl">'</span><span class="s1">./uploads</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">baseUrl</span><span class="p">:</span> <span class="dl">'</span><span class="s1">http://localhost:3000/uploads</span><span class="dl">'</span>
<span class="p">});</span>

<span class="c1">// Use plugins (order matters!)</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">RestApiPlugin</span><span class="p">);</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">FileHandlingPlugin</span><span class="p">);</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">ExpressPlugin</span><span class="p">);</span>

<span class="c1">// Define schema with file field</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">addScope</span><span class="p">(</span><span class="dl">'</span><span class="s1">images</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">schema</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">title</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
    <span class="na">file</span><span class="p">:</span> <span class="p">{</span> 
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">file</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">storage</span><span class="p">:</span> <span class="nx">storage</span><span class="p">,</span>
      <span class="na">accepts</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">image/*</span><span class="dl">'</span><span class="p">],</span>
      <span class="na">maxSize</span><span class="p">:</span> <span class="dl">'</span><span class="s1">10mb</span><span class="dl">'</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<h2 id="schema-configuration">Schema Configuration</h2>

<p>File fields are defined in your scope schema with <code class="language-plaintext highlighter-rouge">type: 'file'</code>:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">api</span><span class="p">.</span><span class="nx">addScope</span><span class="p">(</span><span class="dl">'</span><span class="s1">documents</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">schema</span><span class="p">:</span> <span class="p">{</span>
    <span class="c1">// Regular fields</span>
    <span class="na">title</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
    <span class="na">description</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span> <span class="p">},</span>
    
    <span class="c1">// File field</span>
    <span class="na">attachment</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">file</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">storage</span><span class="p">:</span> <span class="nx">myStorage</span><span class="p">,</span>        <span class="c1">// Required: storage adapter instance</span>
      <span class="na">accepts</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">*</span><span class="dl">'</span><span class="p">],</span>            <span class="c1">// Optional: accepted mime types (default: ['*'])</span>
      <span class="na">maxSize</span><span class="p">:</span> <span class="dl">'</span><span class="s1">50mb</span><span class="dl">'</span><span class="p">,</span>           <span class="c1">// Optional: max file size</span>
      <span class="na">required</span><span class="p">:</span> <span class="kc">false</span>            <span class="c1">// Optional: is field required? (default: false)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="file-field-options">File Field Options</h3>

<ul>
  <li><strong>type</strong>: Must be <code class="language-plaintext highlighter-rouge">'file'</code></li>
  <li><strong>storage</strong>: Storage adapter instance (required)</li>
  <li><strong>accepts</strong>: Array of accepted MIME types
    <ul>
      <li><code class="language-plaintext highlighter-rouge">['*']</code> - Accept any file type (default)</li>
      <li><code class="language-plaintext highlighter-rouge">['image/*']</code> - Accept any image</li>
      <li><code class="language-plaintext highlighter-rouge">['image/jpeg', 'image/png']</code> - Accept specific types</li>
      <li><code class="language-plaintext highlighter-rouge">['application/pdf', 'text/*']</code> - Mix specific and wildcard</li>
    </ul>
  </li>
  <li><strong>maxSize</strong>: Maximum file size
    <ul>
      <li><code class="language-plaintext highlighter-rouge">'10mb'</code>, <code class="language-plaintext highlighter-rouge">'1.5gb'</code>, <code class="language-plaintext highlighter-rouge">'500kb'</code> - Human readable format</li>
      <li>Number of bytes also supported</li>
    </ul>
  </li>
  <li><strong>required</strong>: Whether the file is required</li>
</ul>

<h2 id="storage-adapters">Storage Adapters</h2>

<p>Storage adapters handle where and how files are saved. The library includes two built-in adapters.</p>

<h3 id="storage-adapter-comparison">Storage Adapter Comparison</h3>

<table>
  <thead>
    <tr>
      <th>Feature</th>
      <th>LocalStorage</th>
      <th>S3Storage</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Production Ready</strong></td>
      <td>✅ Yes</td>
      <td>⚠️ Mock only</td>
    </tr>
    <tr>
      <td><strong>Filename Strategies</strong></td>
      <td>4 (hash, timestamp, original, custom)</td>
      <td>1 (hash only)</td>
    </tr>
    <tr>
      <td><strong>Path Traversal Protection</strong></td>
      <td>✅ Full</td>
      <td>✅ N/A</td>
    </tr>
    <tr>
      <td><strong>Extension Whitelist</strong></td>
      <td>✅ Yes</td>
      <td>❌ No</td>
    </tr>
    <tr>
      <td><strong>Duplicate Handling</strong></td>
      <td>✅ Yes</td>
      <td>✅ Automatic</td>
    </tr>
    <tr>
      <td><strong>Custom Naming</strong></td>
      <td>✅ Yes</td>
      <td>❌ No</td>
    </tr>
    <tr>
      <td><strong>Best For</strong></td>
      <td>Local file storage</td>
      <td>Cloud storage</td>
    </tr>
  </tbody>
</table>

<h3 id="s3storage">S3Storage</h3>

<p>Saves files to Amazon S3 or S3-compatible storage:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">S3Storage</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">json-rest-api/plugins/storage/s3-storage.js</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">s3Storage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">S3Storage</span><span class="p">({</span>
  <span class="na">bucket</span><span class="p">:</span> <span class="dl">'</span><span class="s1">my-uploads</span><span class="dl">'</span><span class="p">,</span>                <span class="c1">// S3 bucket name (required)</span>
  <span class="na">region</span><span class="p">:</span> <span class="dl">'</span><span class="s1">us-east-1</span><span class="dl">'</span><span class="p">,</span>                 <span class="c1">// AWS region (default: 'us-east-1')</span>
  <span class="na">prefix</span><span class="p">:</span> <span class="dl">'</span><span class="s1">uploads/</span><span class="dl">'</span><span class="p">,</span>                  <span class="c1">// Path prefix in bucket (default: '')</span>
  <span class="na">acl</span><span class="p">:</span> <span class="dl">'</span><span class="s1">public-read</span><span class="dl">'</span><span class="p">,</span>                  <span class="c1">// Access control (default: 'public-read')</span>
  <span class="na">mockMode</span><span class="p">:</span> <span class="kc">false</span>                      <span class="c1">// Use mock mode? (default: true)</span>
<span class="p">});</span>
</code></pre></div></div>

<p><strong>Filename Handling:</strong></p>
<ul>
  <li>Always generates random hash + extension (e.g., <code class="language-plaintext highlighter-rouge">uploads/a7f8d9e2b4c6e1f3.jpg</code>)</li>
  <li>Original filenames are never used for security</li>
</ul>

<p><strong>Note</strong>: The included S3Storage is a mock implementation for demonstration. For production use, you’ll need to implement the actual AWS SDK calls.</p>

<h3 id="localstorage">LocalStorage</h3>

<p>Saves files to the local filesystem with secure filename handling:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">LocalStorage</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">json-rest-api/plugins/storage/local-storage.js</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">localStorage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LocalStorage</span><span class="p">({</span>
  <span class="na">directory</span><span class="p">:</span> <span class="dl">'</span><span class="s1">./uploads</span><span class="dl">'</span><span class="p">,</span>              <span class="c1">// Where to save files</span>
  <span class="na">baseUrl</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/uploads</span><span class="dl">'</span><span class="p">,</span>                 <span class="c1">// Public URL prefix</span>
  <span class="na">nameStrategy</span><span class="p">:</span> <span class="dl">'</span><span class="s1">hash</span><span class="dl">'</span><span class="p">,</span>                <span class="c1">// Filename strategy (see below)</span>
  <span class="na">preserveExtension</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>             <span class="c1">// Keep file extensions? (default: true)</span>
  <span class="na">allowedExtensions</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">.jpg</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">.png</span><span class="dl">'</span><span class="p">],</span> <span class="c1">// Extension whitelist (optional)</span>
  <span class="na">maxFilenameLength</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>              <span class="c1">// Max filename length</span>
  <span class="na">nameGenerator</span><span class="p">:</span> <span class="k">async</span> <span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{...}</span> <span class="c1">// Custom name generator (optional)</span>
<span class="p">});</span>
</code></pre></div></div>

<p><strong>Filename Strategies:</strong></p>

<ol>
  <li><strong><code class="language-plaintext highlighter-rouge">'hash'</code></strong> (default) - Cryptographically secure random names
    <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">nameStrategy</span><span class="p">:</span> <span class="dl">'</span><span class="s1">hash</span><span class="dl">'</span>
<span class="c1">// Result: "a7f8d9e2b4c6e1f3.jpg"</span>
</code></pre></div>    </div>
  </li>
  <li><strong><code class="language-plaintext highlighter-rouge">'timestamp'</code></strong> - Timestamp with random suffix (sortable)
    <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">nameStrategy</span><span class="p">:</span> <span class="dl">'</span><span class="s1">timestamp</span><span class="dl">'</span>
<span class="c1">// Result: "1672531200000_a8f9.pdf"</span>
</code></pre></div>    </div>
  </li>
  <li><strong><code class="language-plaintext highlighter-rouge">'original'</code></strong> - Sanitized original filename (user-friendly)
    <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">nameStrategy</span><span class="p">:</span> <span class="dl">'</span><span class="s1">original</span><span class="dl">'</span>
<span class="c1">// "My Photo!.jpg" → "My_Photo_.jpg"</span>
<span class="c1">// Duplicates → "My_Photo_1.jpg", "My_Photo_2.jpg"</span>
</code></pre></div>    </div>
  </li>
  <li><strong><code class="language-plaintext highlighter-rouge">'custom'</code></strong> - Your own naming logic
    <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">nameStrategy</span><span class="p">:</span> <span class="dl">'</span><span class="s1">custom</span><span class="dl">'</span><span class="p">,</span>
<span class="nx">nameGenerator</span><span class="p">:</span> <span class="k">async</span> <span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">userId</span> <span class="o">=</span> <span class="nx">file</span><span class="p">.</span><span class="nx">metadata</span><span class="p">?.</span><span class="nx">userId</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">anonymous</span><span class="dl">'</span><span class="p">;</span>
  <span class="k">return</span> <span class="s2">`user_</span><span class="p">${</span><span class="nx">userId</span><span class="p">}</span><span class="s2">_</span><span class="p">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()}</span><span class="s2">`</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">// Result: "user_12345_1672531200000.jpg"</span>
</code></pre></div>    </div>
  </li>
</ol>

<p><strong>Security Features:</strong></p>
<ul>
  <li>Path traversal protection (removes <code class="language-plaintext highlighter-rouge">..</code> and <code class="language-plaintext highlighter-rouge">/</code>)</li>
  <li>Control character filtering</li>
  <li>Extension validation against whitelist</li>
  <li>Automatic duplicate handling</li>
  <li>MIME type to extension mapping</li>
</ul>

<h3 id="custom-storage-adapters">Custom Storage Adapters</h3>

<p>Create your own storage adapter by implementing the required interface:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">MyCustomStorage</span> <span class="p">{</span>
  <span class="k">async</span> <span class="nx">upload</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// file object contains:</span>
    <span class="c1">// - filename: original filename</span>
    <span class="c1">// - mimetype: MIME type</span>
    <span class="c1">// - size: size in bytes</span>
    <span class="c1">// - data: Buffer with file contents</span>
    <span class="c1">// - filepath: temp file path (if using formidable)</span>
    <span class="c1">// - cleanup: async function to cleanup temp files</span>
    
    <span class="c1">// Save the file somewhere</span>
    <span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">saveFileSomewhere</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
    
    <span class="c1">// Return the public URL</span>
    <span class="k">return</span> <span class="nx">url</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="k">async</span> <span class="k">delete</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Optional: implement file deletion</span>
    <span class="k">await</span> <span class="nx">deleteFileSomewhere</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="protocol-configuration">Protocol Configuration</h2>

<p>Different protocols have different configuration options for file parsing.</p>

<h3 id="expressplugin-configuration">ExpressPlugin Configuration</h3>

<p>The Express plugin supports multiple file parsers:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">ExpressPlugin</span><span class="p">,</span> <span class="p">{</span>
  <span class="c1">// Choose parser: 'busboy', 'formidable', or a function</span>
  <span class="na">fileParser</span><span class="p">:</span> <span class="dl">'</span><span class="s1">busboy</span><span class="dl">'</span><span class="p">,</span>
  
  <span class="c1">// Parser-specific options</span>
  <span class="na">fileParserOptions</span><span class="p">:</span> <span class="p">{</span>
    <span class="c1">// For busboy</span>
    <span class="na">limits</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">fileSize</span><span class="p">:</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="c1">// 10MB max file size</span>
      <span class="na">files</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>                     <span class="c1">// Max 5 files per request</span>
      <span class="na">fields</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>                   <span class="c1">// Max 20 non-file fields</span>
      <span class="na">parts</span><span class="p">:</span> <span class="mi">25</span>                     <span class="c1">// Max 25 total parts</span>
    <span class="p">}</span>
  <span class="p">},</span>
  
  <span class="c1">// Or use formidable</span>
  <span class="c1">// fileParser: 'formidable',</span>
  <span class="c1">// fileParserOptions: {</span>
  <span class="c1">//   uploadDir: './temp',        // Temp directory</span>
  <span class="c1">//   keepExtensions: true,       // Keep file extensions</span>
  <span class="c1">//   maxFileSize: 200 * 1024 * 1024  // 200MB max</span>
  <span class="c1">// }</span>
  
  <span class="c1">// Disable file uploads entirely</span>
  <span class="c1">// enableFileUploads: false</span>
<span class="p">});</span>
</code></pre></div></div>

<h4 id="using-express-middleware">Using Express Middleware</h4>

<p>For advanced use cases, you can use Express middleware for file handling:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">multer</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">multer</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">upload</span> <span class="o">=</span> <span class="nx">multer</span><span class="p">({</span> <span class="na">dest</span><span class="p">:</span> <span class="dl">'</span><span class="s1">uploads/</span><span class="dl">'</span> <span class="p">});</span>

<span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">ExpressPlugin</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">middleware</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">beforeScope</span><span class="p">:</span> <span class="p">{</span>
      <span class="c1">// Add multer to specific scope</span>
      <span class="na">images</span><span class="p">:</span> <span class="p">[</span><span class="nx">upload</span><span class="p">.</span><span class="nx">single</span><span class="p">(</span><span class="dl">'</span><span class="s1">file</span><span class="dl">'</span><span class="p">)],</span>
      
      <span class="c1">// Multiple files for another scope</span>
      <span class="na">gallery</span><span class="p">:</span> <span class="p">[</span><span class="nx">upload</span><span class="p">.</span><span class="nx">array</span><span class="p">(</span><span class="dl">'</span><span class="s1">photos</span><span class="dl">'</span><span class="p">,</span> <span class="mi">10</span><span class="p">)]</span>
    <span class="p">}</span>
  <span class="p">},</span>
  
  <span class="c1">// Disable built-in file handling since we're using multer</span>
  <span class="na">enableFileUploads</span><span class="p">:</span> <span class="kc">false</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="httpplugin-configuration">HttpPlugin Configuration</h3>

<p>The HTTP plugin has similar configuration:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">HttpPlugin</span><span class="p">,</span> <span class="p">{</span>
  <span class="c1">// Choose parser: 'busboy', 'formidable', or a function</span>
  <span class="na">fileParser</span><span class="p">:</span> <span class="dl">'</span><span class="s1">formidable</span><span class="dl">'</span><span class="p">,</span>
  
  <span class="na">fileParserOptions</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">uploadDir</span><span class="p">:</span> <span class="dl">'</span><span class="s1">./uploads/temp</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">keepExtensions</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">maxFileSize</span><span class="p">:</span> <span class="mi">100</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>  <span class="c1">// 100MB</span>
  <span class="p">},</span>
  
  <span class="c1">// Other HTTP options</span>
  <span class="na">port</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span>
  <span class="na">basePath</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/api</span><span class="dl">'</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="custom-file-parsers">Custom File Parsers</h3>

<p>You can provide a custom file parser:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">HttpPlugin</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">fileParser</span><span class="p">:</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">({</span>
    <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">my-custom-parser</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">detect</span><span class="p">:</span> <span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// Return true if this parser can handle the request</span>
      <span class="kd">const</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">_httpReq</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="dl">'</span><span class="s1">content-type</span><span class="dl">'</span><span class="p">]?.</span><span class="nx">includes</span><span class="p">(</span><span class="dl">'</span><span class="s1">multipart/form-data</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="na">parse</span><span class="p">:</span> <span class="k">async</span> <span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// Parse the request and return { fields, files }</span>
      <span class="kd">const</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">_httpReq</span><span class="p">;</span>
      <span class="kd">const</span> <span class="p">{</span> <span class="nx">fields</span><span class="p">,</span> <span class="nx">files</span> <span class="p">}</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">myCustomParser</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span>
      <span class="k">return</span> <span class="p">{</span> <span class="nx">fields</span><span class="p">,</span> <span class="nx">files</span> <span class="p">};</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">});</span>
</code></pre></div></div>

<h2 id="file-validation">File Validation</h2>

<p>The FileHandlingPlugin automatically validates files based on schema configuration.</p>

<h3 id="mime-type-validation">MIME Type Validation</h3>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Accept only images</span>
<span class="nx">file</span><span class="p">:</span> <span class="p">{</span>
  <span class="nl">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">file</span><span class="dl">'</span><span class="p">,</span>
  <span class="nx">storage</span><span class="p">:</span> <span class="nx">localStorage</span><span class="p">,</span>
  <span class="nx">accepts</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">image/*</span><span class="dl">'</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1">// Accept specific types</span>
<span class="nl">document</span><span class="p">:</span> <span class="p">{</span>
  <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">file</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">storage</span><span class="p">:</span> <span class="nx">s3Storage</span><span class="p">,</span>
  <span class="na">accepts</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">application/pdf</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">application/msword</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">text/plain</span><span class="dl">'</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1">// Accept anything (not recommended)</span>
<span class="nl">attachment</span><span class="p">:</span> <span class="p">{</span>
  <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">file</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">storage</span><span class="p">:</span> <span class="nx">localStorage</span><span class="p">,</span>
  <span class="na">accepts</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">*</span><span class="dl">'</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="size-validation">Size Validation</h3>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Human-readable format</span>
<span class="nx">avatar</span><span class="p">:</span> <span class="p">{</span>
  <span class="nl">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">file</span><span class="dl">'</span><span class="p">,</span>
  <span class="nx">storage</span><span class="p">:</span> <span class="nx">localStorage</span><span class="p">,</span>
  <span class="nx">maxSize</span><span class="p">:</span> <span class="dl">'</span><span class="s1">5mb</span><span class="dl">'</span>
<span class="p">}</span>

<span class="c1">// Supports: b, kb, mb, gb</span>
<span class="nl">largeFile</span><span class="p">:</span> <span class="p">{</span>
  <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">file</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">storage</span><span class="p">:</span> <span class="nx">s3Storage</span><span class="p">,</span>
  <span class="na">maxSize</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1.5gb</span><span class="dl">'</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="required-files">Required Files</h3>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// This file must be provided</span>
<span class="nb">document</span><span class="p">:</span> <span class="p">{</span>
  <span class="nl">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">file</span><span class="dl">'</span><span class="p">,</span>
  <span class="nx">storage</span><span class="p">:</span> <span class="nx">s3Storage</span><span class="p">,</span>
  <span class="nx">required</span><span class="p">:</span> <span class="kc">true</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="validation-errors">Validation Errors</h3>

<p>When validation fails, you’ll get appropriate error responses:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"errors"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
    </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"422"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Validation Error"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"detail"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Invalid file type for field 'avatar'"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"pointer"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/data/attributes/avatar"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="complete-examples">Complete Examples</h2>

<h3 id="basic-image-upload">Basic Image Upload</h3>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Api</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">hooked-api</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">RestApiPlugin</span><span class="p">,</span> <span class="nx">FileHandlingPlugin</span><span class="p">,</span> <span class="nx">ExpressPlugin</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">json-rest-api</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">LocalStorage</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">json-rest-api/plugins/storage/local-storage.js</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">express</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">;</span>

<span class="c1">// Setup</span>
<span class="kd">const</span> <span class="nx">api</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Api</span><span class="p">({</span> <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">image-api</span><span class="dl">'</span><span class="p">,</span> <span class="na">version</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1.0.0</span><span class="dl">'</span> <span class="p">});</span>
<span class="kd">const</span> <span class="nx">storage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LocalStorage</span><span class="p">({</span>
  <span class="na">directory</span><span class="p">:</span> <span class="dl">'</span><span class="s1">./uploads/images</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">baseUrl</span><span class="p">:</span> <span class="dl">'</span><span class="s1">http://localhost:3000/uploads/images</span><span class="dl">'</span>
<span class="p">});</span>

<span class="c1">// Plugins</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">RestApiPlugin</span><span class="p">);</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">FileHandlingPlugin</span><span class="p">);</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">ExpressPlugin</span><span class="p">);</span>

<span class="c1">// Schema</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">addScope</span><span class="p">(</span><span class="dl">'</span><span class="s1">photos</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">schema</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">caption</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
    <span class="na">image</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">file</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">storage</span><span class="p">:</span> <span class="nx">storage</span><span class="p">,</span>
      <span class="na">accepts</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">image/jpeg</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">image/png</span><span class="dl">'</span><span class="p">],</span>
      <span class="na">maxSize</span><span class="p">:</span> <span class="dl">'</span><span class="s1">10mb</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">required</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// Express app</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="dl">'</span><span class="s1">/uploads</span><span class="dl">'</span><span class="p">,</span> <span class="nx">express</span><span class="p">.</span><span class="kd">static</span><span class="p">(</span><span class="dl">'</span><span class="s1">./uploads</span><span class="dl">'</span><span class="p">));</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">express</span><span class="p">.</span><span class="nx">mount</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>

<span class="c1">// HTML form for testing</span>
<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">`
    &lt;form action="/api/photos" method="POST" enctype="multipart/form-data"&gt;
      &lt;input name="caption" placeholder="Caption" required&gt;
      &lt;input name="image" type="file" accept="image/*" required&gt;
      &lt;button type="submit"&gt;Upload Photo&lt;/button&gt;
    &lt;/form&gt;
  `</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="multiple-storage-backends">Multiple Storage Backends</h3>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Different storage for different fields</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">addScope</span><span class="p">(</span><span class="dl">'</span><span class="s1">articles</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">schema</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">title</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
    <span class="na">content</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
    
    <span class="c1">// Featured image goes to S3</span>
    <span class="na">featuredImage</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">file</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">storage</span><span class="p">:</span> <span class="nx">s3Storage</span><span class="p">,</span>
      <span class="na">accepts</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">image/*</span><span class="dl">'</span><span class="p">],</span>
      <span class="na">maxSize</span><span class="p">:</span> <span class="dl">'</span><span class="s1">20mb</span><span class="dl">'</span>
    <span class="p">},</span>
    
    <span class="c1">// Attachments stay local</span>
    <span class="na">attachment</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">file</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">storage</span><span class="p">:</span> <span class="nx">localStorage</span><span class="p">,</span>
      <span class="na">accepts</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">application/pdf</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">application/zip</span><span class="dl">'</span><span class="p">],</span>
      <span class="na">maxSize</span><span class="p">:</span> <span class="dl">'</span><span class="s1">100mb</span><span class="dl">'</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="filename-handling-examples">Filename Handling Examples</h3>

<p>Different strategies for different use cases:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">LocalStorage</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">json-rest-api/plugins/storage/local-storage.js</span><span class="dl">'</span><span class="p">;</span>

<span class="c1">// User avatars - use hash for security and deduplication</span>
<span class="kd">const</span> <span class="nx">avatarStorage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LocalStorage</span><span class="p">({</span>
  <span class="na">directory</span><span class="p">:</span> <span class="dl">'</span><span class="s1">./uploads/avatars</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">baseUrl</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/uploads/avatars</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">nameStrategy</span><span class="p">:</span> <span class="dl">'</span><span class="s1">hash</span><span class="dl">'</span>
<span class="p">});</span>

<span class="c1">// Documents - use timestamp for sorting</span>
<span class="kd">const</span> <span class="nx">documentStorage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LocalStorage</span><span class="p">({</span>
  <span class="na">directory</span><span class="p">:</span> <span class="dl">'</span><span class="s1">./uploads/documents</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">baseUrl</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/uploads/documents</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">nameStrategy</span><span class="p">:</span> <span class="dl">'</span><span class="s1">timestamp</span><span class="dl">'</span>
<span class="p">});</span>

<span class="c1">// User downloads - preserve original names</span>
<span class="kd">const</span> <span class="nx">downloadStorage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LocalStorage</span><span class="p">({</span>
  <span class="na">directory</span><span class="p">:</span> <span class="dl">'</span><span class="s1">./uploads/downloads</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">baseUrl</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/uploads/downloads</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">nameStrategy</span><span class="p">:</span> <span class="dl">'</span><span class="s1">original</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">maxFilenameLength</span><span class="p">:</span> <span class="mi">100</span>
<span class="p">});</span>

<span class="c1">// High security - no extensions</span>
<span class="kd">const</span> <span class="nx">secureStorage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LocalStorage</span><span class="p">({</span>
  <span class="na">directory</span><span class="p">:</span> <span class="dl">'</span><span class="s1">./uploads/secure</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">baseUrl</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/uploads/secure</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">nameStrategy</span><span class="p">:</span> <span class="dl">'</span><span class="s1">hash</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">preserveExtension</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>  <span class="c1">// All files saved as .bin</span>
  <span class="na">allowedExtensions</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">.pdf</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">.doc</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">.docx</span><span class="dl">'</span><span class="p">]</span>  <span class="c1">// Still validates input</span>
<span class="p">});</span>

<span class="c1">// Organized by date</span>
<span class="kd">const</span> <span class="nx">organizedStorage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LocalStorage</span><span class="p">({</span>
  <span class="na">directory</span><span class="p">:</span> <span class="dl">'</span><span class="s1">./uploads</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">baseUrl</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/uploads</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">nameStrategy</span><span class="p">:</span> <span class="dl">'</span><span class="s1">custom</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">nameGenerator</span><span class="p">:</span> <span class="k">async</span> <span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">dateDir</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">date</span><span class="p">.</span><span class="nx">getFullYear</span><span class="p">()}</span><span class="s2">/</span><span class="p">${</span><span class="nb">String</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getMonth</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">).</span><span class="nx">padStart</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="dl">'</span><span class="s1">0</span><span class="dl">'</span><span class="p">)}</span><span class="s2">`</span><span class="p">;</span>
    <span class="k">return</span> <span class="s2">`</span><span class="p">${</span><span class="nx">dateDir</span><span class="p">}</span><span class="s2">/</span><span class="p">${</span><span class="nx">crypto</span><span class="p">.</span><span class="nx">randomBytes</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="dl">'</span><span class="s1">hex</span><span class="dl">'</span><span class="p">)}</span><span class="s2">`</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span>
<span class="c1">// Saves as: "2024/01/a7f8d9e2b4c6e1f3.jpg"</span>
</code></pre></div></div>

<h3 id="using-curl">Using cURL</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Upload with cURL</span>
curl <span class="nt">-X</span> POST http://localhost:3000/api/photos <span class="se">\</span>
  <span class="nt">-F</span> <span class="s2">"caption=Beautiful sunset"</span> <span class="se">\</span>
  <span class="nt">-F</span> <span class="s2">"image=@/path/to/sunset.jpg"</span>

<span class="c"># Multiple files</span>
curl <span class="nt">-X</span> POST http://localhost:3000/api/articles <span class="se">\</span>
  <span class="nt">-F</span> <span class="s2">"title=My Article"</span> <span class="se">\</span>
  <span class="nt">-F</span> <span class="s2">"content=Article content here"</span> <span class="se">\</span>
  <span class="nt">-F</span> <span class="s2">"featuredImage=@/path/to/hero.jpg"</span> <span class="se">\</span>
  <span class="nt">-F</span> <span class="s2">"attachment=@/path/to/document.pdf"</span>
</code></pre></div></div>

<h3 id="programmatic-upload">Programmatic Upload</h3>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Using fetch with FormData</span>
<span class="kd">const</span> <span class="nx">formData</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FormData</span><span class="p">();</span>
<span class="nx">formData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">'</span><span class="s1">caption</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">My photo</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">formData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">'</span><span class="s1">image</span><span class="dl">'</span><span class="p">,</span> <span class="nx">fileInput</span><span class="p">.</span><span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

<span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="dl">'</span><span class="s1">/api/photos</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">body</span><span class="p">:</span> <span class="nx">formData</span>
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Uploaded:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">result</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">image</span><span class="p">);</span> <span class="c1">// URL of uploaded file</span>
</code></pre></div></div>

<h2 id="troubleshooting">Troubleshooting</h2>

<h3 id="common-issues">Common Issues</h3>

<h4 id="1-busboy-not-available-file-uploads-disabled">1. “Busboy not available, file uploads disabled”</h4>

<p>Install the peer dependency:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm <span class="nb">install </span>busboy
</code></pre></div></div>

<h4 id="2-no-storage-configured-for-file-field">2. “No storage configured for file field”</h4>

<p>Make sure you’ve set the storage property:</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">file</span><span class="p">:</span> <span class="p">{</span>
  <span class="nl">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">file</span><span class="dl">'</span><span class="p">,</span>
  <span class="nx">storage</span><span class="p">:</span> <span class="nx">myStorage</span>  <span class="c1">// This is required!</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="3-files-not-being-detected">3. Files not being detected</h4>

<p>Check that:</p>
<ol>
  <li>The FileHandlingPlugin is loaded AFTER RestApiPlugin</li>
  <li>Your protocol plugin has file uploads enabled</li>
  <li>The request has proper multipart headers</li>
  <li>You’re using the correct form encoding</li>
</ol>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- HTML forms need this --&gt;</span>
<span class="nt">&lt;form</span> <span class="na">enctype=</span><span class="s">"multipart/form-data"</span><span class="nt">&gt;</span>
</code></pre></div></div>

<h4 id="4-file-too-large-errors">4. “File too large” errors</h4>

<p>Check both:</p>
<ol>
  <li>Schema <code class="language-plaintext highlighter-rouge">maxSize</code> configuration</li>
  <li>Parser limits in plugin options</li>
</ol>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Both limits apply!</span>
<span class="nx">api</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">ExpressPlugin</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">fileParserOptions</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">limits</span><span class="p">:</span> <span class="p">{</span> <span class="na">fileSize</span><span class="p">:</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="p">}</span>  <span class="c1">// 10MB parser limit</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">api</span><span class="p">.</span><span class="nx">addScope</span><span class="p">(</span><span class="dl">'</span><span class="s1">images</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">schema</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">photo</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">file</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">maxSize</span><span class="p">:</span> <span class="dl">'</span><span class="s1">5mb</span><span class="dl">'</span>  <span class="c1">// 5MB schema limit (lower wins)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="debug-mode">Debug Mode</h3>

<p>Enable debug logging to see what’s happening:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">api</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Api</span><span class="p">({</span>
  <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">my-api</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">version</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1.0.0</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">logLevel</span><span class="p">:</span> <span class="dl">'</span><span class="s1">debug</span><span class="dl">'</span>  <span class="c1">// or 'trace' for more detail</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="testing-file-uploads">Testing File Uploads</h3>

<p>Use the included example to test your setup:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Run the example</span>
<span class="nx">node</span> <span class="p">.</span><span class="o">/</span><span class="nx">node_modules</span><span class="o">/</span><span class="nx">json</span><span class="o">-</span><span class="nx">rest</span><span class="o">-</span><span class="nx">api</span><span class="o">/</span><span class="nx">examples</span><span class="o">/</span><span class="nx">file</span><span class="o">-</span><span class="nx">upload</span><span class="o">-</span><span class="nx">example</span><span class="p">.</span><span class="nx">js</span>
</code></pre></div></div>

<p>Then visit http://localhost:3000 to see the test forms.</p>

<h2 id="best-practices">Best Practices</h2>

<ol>
  <li><strong>Always validate file types</strong> - Don’t use <code class="language-plaintext highlighter-rouge">accepts: ['*']</code> in production</li>
  <li><strong>Set reasonable size limits</strong> - Prevent abuse and server overload</li>
  <li><strong>Use appropriate storage</strong> - Local for small files, S3 for large/many files</li>
  <li><strong>Clean up temp files</strong> - Storage adapters should handle cleanup</li>
  <li><strong>Serve files separately</strong> - Don’t serve uploaded files through your API</li>
  <li><strong>Validate file contents</strong> - Consider virus scanning for user uploads</li>
  <li><strong>Use CDN for images</strong> - Serve uploaded images through a CDN in production</li>
</ol>

<h2 id="security-considerations">Security Considerations</h2>

<h3 id="filename-security">Filename Security</h3>

<ol>
  <li><strong>Never trust user filenames</strong> - Always sanitize or generate new names
    <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// BAD - Direct use of user filename</span>
<span class="kd">const</span> <span class="nx">filename</span> <span class="o">=</span> <span class="nx">file</span><span class="p">.</span><span class="nx">originalname</span><span class="p">;</span>
   
<span class="c1">// GOOD - Generate secure name</span>
<span class="kd">const</span> <span class="nx">filename</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">randomBytes</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="dl">'</span><span class="s1">hex</span><span class="dl">'</span><span class="p">)</span> <span class="o">+</span> <span class="nx">path</span><span class="p">.</span><span class="nx">extname</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">originalname</span><span class="p">);</span>
</code></pre></div>    </div>
  </li>
  <li><strong>Prevent path traversal</strong> - Remove dangerous characters
    <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Dangerous filenames to watch for:</span>
<span class="c1">// "../../../etc/passwd"</span>
<span class="c1">// "..\\..\\windows\\system32\\config\\sam"</span>
<span class="c1">// "uploads/../../../index.js"</span>
   
<span class="c1">// LocalStorage handles this automatically</span>
</code></pre></div>    </div>
  </li>
  <li><strong>Extension validation</strong> - Whitelist allowed extensions
    <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Use LocalStorage with whitelist</span>
<span class="kd">const</span> <span class="nx">storage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LocalStorage</span><span class="p">({</span>
  <span class="na">allowedExtensions</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">.jpg</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">.jpeg</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">.png</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">.pdf</span><span class="dl">'</span><span class="p">]</span>
<span class="p">});</span>
</code></pre></div>    </div>
  </li>
  <li><strong>Consider removing extensions entirely</strong> for sensitive files
    <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">highSecurityStorage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LocalStorage</span><span class="p">({</span>
  <span class="na">nameStrategy</span><span class="p">:</span> <span class="dl">'</span><span class="s1">hash</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">preserveExtension</span><span class="p">:</span> <span class="kc">false</span>  <span class="c1">// All files become .bin</span>
<span class="p">});</span>
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="general-file-security">General File Security</h3>

<ol>
  <li><strong>Validate MIME types</strong> - But remember they can be spoofed</li>
  <li><strong>Check file contents</strong> - Use libraries like <code class="language-plaintext highlighter-rouge">file-type</code> for verification</li>
  <li><strong>Limit upload sizes</strong> - Prevent denial of service</li>
  <li><strong>Store files outside web root</strong> - Prevent direct execution</li>
  <li><strong>Use virus scanning</strong> - For user-uploaded content</li>
  <li><strong>Set proper permissions</strong> - Uploaded files shouldn’t be executable</li>
  <li><strong>Serve files with proper headers</strong> - Use Content-Disposition for downloads</li>
</ol>

<h2 id="next-steps">Next Steps</h2>

<ul>
  <li>Implement production S3 storage with actual AWS SDK</li>
  <li>Add image processing (thumbnails, resizing)</li>
  <li>Implement virus scanning for uploads</li>
  <li>Add progress tracking for large files</li>
  <li>Create a chunked upload system for very large files</li>
</ul>

    </div>
  </main>

  <footer>
    <div class="wrapper">
      <p>JSON REST API &copy; 2025 - MIT License</p>
    </div>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Add copy buttons to all code blocks
      document.querySelectorAll('pre').forEach(function(pre) {
        // Skip if button already exists
        if (pre.querySelector('.copy-button')) return;
        
        const button = document.createElement('button');
        button.className = 'copy-button';
        button.textContent = 'Copy';
        button.addEventListener('click', function() {
          const code = pre.querySelector('code') ? 
            pre.querySelector('code').textContent : 
            pre.textContent;
          
          navigator.clipboard.writeText(code).then(function() {
            button.textContent = '✓ Copied!';
            button.classList.add('copied');
            setTimeout(() => {
              button.textContent = 'Copy';
              button.classList.remove('copied');
            }, 2000);
          }).catch(function() {
            // Fallback for older browsers
            const textarea = document.createElement('textarea');
            textarea.value = code;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            
            button.textContent = '✓ Copied!';
            button.classList.add('copied');
            setTimeout(() => {
              button.textContent = 'Copy';
              button.classList.remove('copied');
            }, 2000);
          });
        });
        pre.appendChild(button);
      });
    });
  </script>
</body>
</html>